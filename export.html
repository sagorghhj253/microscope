<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HemaScan Pro - Export Data</title>
    <link rel="stylesheet" href="common-styles.css">
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1 class="app-title">üì§ Export Data</h1>
            <p class="app-subtitle">SAVE ANALYSIS RESULTS</p>
        </div>

        <div class="results-grid">
            <div class="result-card">
                <div class="result-label">Total Records</div>
                <div class="result-value" id="totalRecords">0</div>
            </div>
            <div class="result-card">
                <div class="result-label">Date Range</div>
                <div class="result-value" style="font-size: 12px;" id="dateRange">-</div>
            </div>
            <div class="result-card">
                <div class="result-label">File Size</div>
                <div class="result-value" style="font-size: 18px;" id="fileSize">-</div>
            </div>
            <div class="result-card">
                <div class="result-label">Format</div>
                <div class="result-value" style="font-size: 20px;">CSV</div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">üìã Export Options</div>
            <div>
                <div class="setting-item">
                    <span class="setting-label">Include timestamps</span>
                    <div class="toggle-switch active" id="timestampToggle" onclick="toggleOption('timestamp')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Include cell counts</span>
                    <div class="toggle-switch active" id="cellCountToggle" onclick="toggleOption('cellCount')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Include source info</span>
                    <div class="toggle-switch active" id="sourceToggle" onclick="toggleOption('source')"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Include confidence</span>
                    <div class="toggle-switch active" id="confidenceToggle" onclick="toggleOption('confidence')"></div>
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">üìÑ Preview</div>
            <div id="previewContent" style="background: #f8f9fa; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 11px; overflow-x: auto; white-space: pre;">
Loading preview...
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn primary" onclick="exportToCSV()">
                üíæ Export CSV
            </button>
            <button class="action-btn success" onclick="shareData()">
                üì≤ Share
            </button>
        </div>

        <div class="action-buttons">
            <button class="action-btn success" onclick="window.location.href='index.html'">
                üè† Home
            </button>
            <button class="action-btn danger" onclick="window.location.href='index.html'">
                ‚ùå Close
            </button>
        </div>
    </div>

    <script>
        let exportOptions = {
            timestamp: true,
            cellCount: true,
            source: true,
            confidence: true
        };

        function loadExportInfo() {
            const savedData = localStorage.getItem('hemaScanData');
            
            if (!savedData) {
                document.getElementById('totalRecords').textContent = '0';
                document.getElementById('dateRange').textContent = '-';
                document.getElementById('fileSize').textContent = '0 KB';
                updatePreview([]);
                return;
            }

            const data = JSON.parse(savedData);
            const readings = data.readings || [];

            document.getElementById('totalRecords').textContent = readings.length;

            if (readings.length > 0) {
                const dates = readings.map(r => new Date(r.timestamp));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                const dateRangeStr = minDate.toLocaleDateString() + ' - ' + maxDate.toLocaleDateString();
                document.getElementById('dateRange').textContent = dateRangeStr;

                const csvContent = generateCSV(readings);
                const sizeKB = (new Blob([csvContent]).size / 1024).toFixed(1);
                document.getElementById('fileSize').textContent = sizeKB + ' KB';
            } else {
                document.getElementById('dateRange').textContent = '-';
                document.getElementById('fileSize').textContent = '0 KB';
            }

            updatePreview(readings);
        }

        function toggleOption(option) {
            exportOptions[option] = !exportOptions[option];
            const toggle = document.getElementById(option + 'Toggle');
            
            if (exportOptions[option]) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }

            // Reload preview
            const savedData = localStorage.getItem('hemaScanData');
            if (savedData) {
                const data = JSON.parse(savedData);
                updatePreview(data.readings || []);
            }
        }

        function generateCSV(readings) {
            let csv = '';
            
            // Header
            const headers = [];
            if (exportOptions.timestamp) headers.push('Timestamp');
            if (exportOptions.cellCount) {
                headers.push('Total Cells', 'RBC Count', 'WBC Count');
            }
            headers.push('Processing Time (ms)');
            if (exportOptions.confidence) headers.push('Confidence (%)');
            if (exportOptions.source) headers.push('Source');
            
            csv += headers.join(',') + '\n';

            // Data rows
            readings.forEach(r => {
                const row = [];
                if (exportOptions.timestamp) row.push(r.timestamp);
                if (exportOptions.cellCount) {
                    row.push(r.totalCells || 0, r.rbcCount || 0, r.wbcCount || 0);
                }
                row.push(r.processingTime || 0);
                if (exportOptions.confidence) row.push(r.confidence || '-');
                if (exportOptions.source) row.push(r.source || 'live');
                
                csv += row.join(',') + '\n';
            });

            return csv;
        }

        function updatePreview(readings) {
            const preview = document.getElementById('previewContent');
            
            if (readings.length === 0) {
                preview.textContent = 'No data available for export.';
                return;
            }

            const csvContent = generateCSV(readings);
            const lines = csvContent.split('\n');
            const previewLines = lines.slice(0, 6); // Show first 5 data rows + header
            
            preview.textContent = previewLines.join('\n');
            
            if (lines.length > 6) {
                preview.textContent += '\n... (' + (lines.length - 6) + ' more rows)';
            }
        }

        function exportToCSV() {
            const savedData = localStorage.getItem('hemaScanData');
            
            if (!savedData) {
                alert('No data available to export!');
                return;
            }

            const data = JSON.parse(savedData);
            const readings = data.readings || [];

            if (readings.length === 0) {
                alert('No data available to export!');
                return;
            }

            const csvContent = generateCSV(readings);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `hemascan-data-${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert(`Exported ${readings.length} records successfully!`);
        }

        function shareData() {
            const savedData = localStorage.getItem('hemaScanData');
            
            if (!savedData) {
                alert('No data available to share!');
                return;
            }

            const data = JSON.parse(savedData);
            const readings = data.readings || [];

            if (readings.length === 0) {
                alert('No data available to share!');
                return;
            }

            const csvContent = generateCSV(readings);
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const file = new File([blob], `hemascan-data-${new Date().toISOString().slice(0, 10)}.csv`, { type: 'text/csv' });

            // Check if Web Share API is available
            if (navigator.share) {
                navigator.share({
                    files: [file],
                    title: 'HemaScan Pro Analysis Data',
                    text: `Analysis data with ${readings.length} readings`
                }).then(() => {
                    alert('Data shared successfully!');
                }).catch((error) => {
                    console.error('Error sharing:', error);
                    // Fallback to download
                    exportToCSV();
                });
            } else {
                alert('Share not supported on this device. Downloading instead.');
                exportToCSV();
            }
        }

        function checkClinicalMode() {
            const clinicalMode = localStorage.getItem('clinicalMode') === 'true';
            if (clinicalMode) {
                document.body.classList.add('dark-mode');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadExportInfo();
            checkClinicalMode();
        });
    </script>
</body>
</html>
