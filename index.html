<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Mode - Rehabilitation Tracker</title>
    <style>
        /* Patient Mode Specific Styles */
        .container {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            padding-top: 60px;
        }

        header {
            margin-bottom: 30px;
            padding: 20px;
            text-align: center;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 25px;
            margin-bottom: 30px;
        }

        .sidebar,
        .camera-section,
        .stats-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: left;
        }

        .model-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .indicator-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .indicator-pose { background-color: #4776E6; }
        .indicator-hands { background-color: #43e97b; }
        .indicator-face { background-color: #fa709a; }

        .body-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .body-option {
            padding: 18px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .body-option:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .body-option.active {
            background: rgba(71, 118, 230, 0.2);
            border-color: #4776E6;
        }

        .body-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .exercise-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .exercise-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.07);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            border: 1px solid transparent;
        }

        .exercise-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .exercise-item.active {
            background: rgba(0, 242, 254, 0.15);
            border-color: #00f2fe;
        }

        .exercise-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #00f2fe;
        }

        .exercise-model {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-right: 8px;
        }

        .model-pose { background: rgba(71, 118, 230, 0.3); }
        .model-hands { background: rgba(67, 233, 123, 0.3); }
        .model-face { background: rgba(250, 112, 154, 0.3); }

        .camera-container {
            position: relative;
            width: 100%;
            height: 500px;
            overflow: hidden;
            border-radius: 15px;
            background: #000;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .exercise-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .control-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(90deg, #4776E6, #8E54E9);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .control-btn:disabled {
            background: linear-gradient(90deg, #6c757d, #868e96);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .session-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00f2fe;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .feedback-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            padding-right: 10px;
        }

        .feedback-item {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #4776E6;
            text-align: left;
            font-size: 0.9rem;
        }

        .feedback-item.good {
            border-left-color: #43e97b;
        }

        .feedback-item.warning {
            border-left-color: #fa709a;
        }

        .feedback-item.error {
            border-left-color: #ff5858;
        }

        .instructions-container {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            text-align: left;
        }

        .instructions-container h3 {
            color: #4facfe;
            margin-bottom: 10px;
        }

        .instructions-container p {
            opacity: 0.8;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Video Guidance Popup Styles */
        .video-guidance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .video-guidance-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .video-guidance-container {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .video-guidance-overlay.active .video-guidance-container {
            transform: translateY(0);
        }

        .video-guidance-header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-guidance-header h2 {
            margin: 0;
            font-size: 22px;
        }

        .close-video-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-video-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .video-guidance-body {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .video-player-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        #guidanceVideo {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
        }

        .video-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 15px;
            background: #f8f9ff;
        }

        .video-control-btn {
            padding: 10px 25px;
            background: #6a11cb;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .video-control-btn:hover {
            background: #5a0db3;
            transform: translateY(-2px);
        }

        .video-control-btn.pause {
            background: #2575fc;
        }

        .video-control-btn.pause:hover {
            background: #1a68ea;
        }

        .video-control-btn.replay {
            background: #00b894;
        }

        .video-control-btn.replay:hover {
            background: #00a085;
        }

        .video-instructions {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #6a11cb;
        }

        .video-instructions h3 {
            margin-top: 0;
            color: #333;
            margin-bottom: 15px;
        }

        .video-instructions ol {
            margin: 0;
            padding-left: 20px;
            color: #555;
        }

        .video-instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .video-tips {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .tip-item {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-top: 3px solid #6a11cb;
        }

        .tip-item.warning {
            border-top-color: #ff4757;
        }

        .tip-item.success {
            border-top-color: #00b894;
        }

        .tip-item h4 {
            margin-top: 0;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tip-item p {
            margin: 0;
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .auto-close-notice {
            text-align: center;
            padding: 10px;
            background: #fff8e1;
            border-radius: 6px;
            color: #ff9800;
            font-weight: 600;
            border: 1px dashed #ff9800;
        }

        /* Patient Modal Styles */
        .patient-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .patient-modal {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            position: relative;
            z-index: 2001;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .patient-modal-header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px 30px;
        }

        .patient-modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .patient-modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6a11cb;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-submit {
            flex: 2;
            padding: 15px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(106, 17, 203, 0.2);
        }

        .btn-cancel {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            color: #666;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #e9ecef;
        }

        /* Navigation Styles */
        .patient-nav {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: #6a11cb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn:hover {
            background: #5a0db3;
            transform: translateY(-2px);
        }

        /* Close when clicking on overlay */
        .patient-modal-overlay.active {
            display: flex;
        }

        /* Basic styles */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
        }

        .back-home {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            transition: background 0.3s ease;
        }

        .back-home:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .camera-container {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .camera-container {
                height: 300px;
            }
            
            .exercise-controls {
                grid-template-columns: 1fr;
            }
            
            .video-guidance-container {
                width: 95%;
                max-height: 95vh;
            }
            
            .video-guidance-body {
                padding: 20px;
            }
            
            .video-guidance-header h2 {
                font-size: 18px;
            }
            
            .video-controls {
                flex-wrap: wrap;
            }
            
            .video-control-btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
            
            .tip-item {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-home">‚Üê Back to Home</a>
    
    <nav class="patient-nav">
        <button onclick="viewMyProgress()" class="nav-btn">
            <span>üìä</span> View My Progress
        </button>
        <button onclick="showPatientModal()" class="nav-btn">
            <span>üë§</span> Change Patient
        </button>
    </nav>
    
    <div class="container">
        <header>
            <h1>Patient Exercise Tracker</h1>
            <p class="subtitle">Real-time AI feedback for your rehabilitation exercises</p>
        </header>
        
        <div class="dashboard">
            <div class="sidebar">
                <h2 class="section-title">Exercise Selection</h2>
                
                <div class="model-indicator">
                    <div class="indicator-dot indicator-pose"></div>
                    <span>Pose Model Active</span>
                </div>
                
                <div class="body-options">
                    <div class="body-option active" data-body="neck">
                        <div class="body-icon">üß†</div>
                        <div>
                            <h3>Neck Exercises</h3>
                            <p>Head and neck movements</p>
                        </div>
                    </div>
                    <div class="body-option" data-body="upper">
                        <div class="body-icon">üí™</div>
                        <div>
                            <h3>Upper Body</h3>
                            <p>Shoulder and arm exercises</p>
                        </div>
                    </div>
                    <div class="body-option" data-body="hand">
                        <div class="body-icon">‚úã</div>
                        <div>
                            <h3>Hand & Wrist</h3>
                            <p>Wrist and finger exercises</p>
                        </div>
                    </div>
                    <div class="body-option" data-body="lower">
                        <div class="body-icon">ü¶µ</div>
                        <div>
                            <h3>Lower Body</h3>
                            <p>Leg and lower body exercises</p>
                        </div>
                    </div>
                </div>
                
                <div class="exercise-list" id="exerciseList">
                    <!-- Exercises will be populated dynamically -->
                </div>
            </div>
            
            <div class="camera-section">
                <h2 class="section-title">Live Tracking</h2>
                <div class="camera-container">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                
                <div class="exercise-controls">
                    <button class="control-btn" id="startExerciseBtn">
                        <span>‚ñ∂</span> Start Exercise
                    </button>
                    <button class="control-btn" id="pauseExerciseBtn" disabled>
                        <span>‚è∏</span> Pause
                    </button>
                    <button class="control-btn" id="endSessionBtn" disabled>
                        <span>‚èπ</span> End Session
                    </button>
                </div>
                
                <div class="session-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="repCount">0</div>
                        <div class="stat-label">Repetitions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sessionTime">0:00</div>
                        <div class="stat-label">Session Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="formScore">100%</div>
                        <div class="stat-label">Form Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentModel">Pose</div>
                        <div class="stat-label">Active Model</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section">
                <h2 class="section-title">Exercise Feedback</h2>
                <div class="feedback-list" id="feedbackList">
                    <div class="feedback-item">Select an exercise and click "Start Exercise" to begin tracking</div>
                </div>
                
                <div class="instructions-container">
                    <h3>Exercise Instructions</h3>
                    <div id="exerciseInstructions">
                        <p>Select a body part from the left panel, then choose an exercise from the list. Click "Start Exercise" to begin tracking your form and repetitions.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Guidance Popup -->
    <div class="video-guidance-overlay" id="videoGuidanceOverlay">
        <div class="video-guidance-container">
            <div class="video-guidance-header">
                <h2 id="videoExerciseTitle">Exercise Guidance Video</h2>
                <button class="close-video-btn" id="closeVideoBtn">&times;</button>
            </div>
            
            <div class="video-guidance-body">
                <div class="video-player-container">
                    <video id="guidanceVideo" controls>
                        <source id="videoSource" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                
                <div class="video-controls">
                    <button class="video-control-btn" id="playPauseBtn">
                        <span>‚ñ∂</span> Play Video
                    </button>
                    <button class="video-control-btn replay" id="replayBtn">
                        <span>‚Üª</span> Replay
                    </button>
                    <button class="video-control-btn" id="skipVideoBtn">
                        <span>‚è≠</span> Skip & Start Exercise
                    </button>
                </div>
                
                <div class="video-instructions">
                    <h3>Exercise Instructions</h3>
                    <ol id="videoInstructionsList">
                        <li>Watch the video demonstration carefully</li>
                        <li>Pay attention to the correct form and posture</li>
                        <li>Note the range of motion</li>
                        <li>Follow the breathing pattern if shown</li>
                    </ol>
                </div>
                
                <div class="video-tips">
                    <div class="tip-item">
                        <h4>‚úÖ Safety Tips</h4>
                        <p>Start slowly and gradually increase intensity. Stop if you feel pain.</p>
                    </div>
                    <div class="tip-item warning">
                        <h4>‚ö†Ô∏è Important Notes</h4>
                        <p>Maintain proper posture throughout the exercise. Don't rush the movements.</p>
                    </div>
                    <div class="tip-item success">
                        <h4>üéØ Success Tips</h4>
                        <p>Focus on quality over quantity. Proper form is more important than speed.</p>
                    </div>
                </div>
                
                <div class="auto-close-notice" id="autoCloseNotice">
                    ‚è∞ This video will close automatically in <span id="countdownTimer">30</span> seconds
                </div>
            </div>
        </div>
    </div>
    
    <!-- Patient Name Modal -->
    <div class="patient-modal-overlay" id="patientModal">
        <div class="patient-modal">
            <div class="patient-modal-header">
                <h2>Enter Patient Information</h2>
                <button class="modal-close-btn" onclick="closePatientModal()">&times;</button>
            </div>
            <div class="patient-modal-body">
                <form id="patientForm">
                    <div class="form-group">
                        <label for="patientNameInput">Patient Name *</label>
                        <input type="text" id="patientNameInput" required 
                               placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="patientCondition">Condition/Injury</label>
                        <input type="text" id="patientCondition" 
                               placeholder="e.g., Post Shoulder Surgery">
                    </div>
                    
                    <div class="form-group">
                        <label for="patientAge">Age</label>
                        <input type="number" id="patientAge" min="1" max="120" 
                               placeholder="Enter your age">
                    </div>
                    
                    <div class="form-group">
                        <label for="patientNotes">Notes (Optional)</label>
                        <textarea id="patientNotes" rows="3" 
                                  placeholder="Any specific instructions or concerns..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Start Exercise Session</button>
                        <button type="button" class="btn-cancel" onclick="closePatientModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startExerciseBtn = document.getElementById('startExerciseBtn');
        const pauseExerciseBtn = document.getElementById('pauseExerciseBtn');
        const endSessionBtn = document.getElementById('endSessionBtn');
        const exerciseList = document.getElementById('exerciseList');
        const feedbackList = document.getElementById('feedbackList');
        const exerciseInstructions = document.getElementById('exerciseInstructions');
        const repCount = document.getElementById('repCount');
        const sessionTime = document.getElementById('sessionTime');
        const formScore = document.getElementById('formScore');
        const currentModel = document.getElementById('currentModel');
        const modelIndicator = document.querySelector('.model-indicator span');

        // ===== VIDEO GUIDANCE VARIABLES =====
        let guidanceVideo = null;
        let videoSource = null;
        let countdownInterval = null;
        let autoCloseTime = 30; // seconds
        let currentVideoExercise = '';
        let isVideoPlaying = false;

        // Exercise to video mapping (add more as needed)
        const exerciseVideos = {
            // Neck Exercises
            "Neck Flexion & Extension": "neck_flexion.mp4",
            "Neck Rotation": "neck_rotation.mp4",
            
            // Upper Body
            "Shoulder Abduction": "shoulder_abduction.mp4",
            "Shoulder Flexion": "shoulder_flexion.mp4",
            "Elbow Flexion & Extension": "elbow_flexion.mp4",
            
            // Hand & Wrist
            "Wrist Flexion & Extension": "wrist_flexion.mp4",
            "Finger Squeeze & Open": "finger_flexion.mp4",
            
            // Lower Body
            "Squat": "squat.mp4"
        };

        // Default video if specific one doesn't exist
        const defaultVideos = {
            "neck": "neck_stretch.mp4",
            "upper": "shoulder_press.mp4",
            "hand": "wrist_flexion.mp4",
            "lower": "squat.mp4"
        };

        // Exercise-specific instructions
        const exerciseInstructionsMap = {
            "Neck Flexion & Extension": [
                "Sit or stand with your back straight",
                "Slowly bend head forward (chin to chest)",
                "Hold for 2-3 seconds",
                "Gently tilt backward looking up",
                "Return to neutral position"
            ],
            "Neck Rotation": [
                "Sit or stand with your back straight",
                "Slowly turn your head to the right until you feel a gentle stretch",
                "Hold for 2-3 seconds",
                "Return to center and repeat on the left side",
                "Keep shoulders relaxed throughout"
            ],
            "Shoulder Abduction": [
                "Stand with feet shoulder-width apart",
                "Raise arms sideways to shoulder height",
                "Palms facing down",
                "Slowly lower back down",
                "Keep movements controlled"
            ],
            "Shoulder Flexion": [
                "Stand with feet shoulder-width apart",
                "Raise arms forward to shoulder height",
                "Palms facing each other",
                "Slowly lower back down",
                "Keep core engaged throughout"
            ],
            "Elbow Flexion & Extension": [
                "Stand with arms by your side",
                "Bend elbow bringing hand to shoulder",
                "Hold for 1-2 seconds",
                "Straighten arm completely",
                "Repeat on both sides"
            ],
            "Wrist Flexion & Extension": [
                "Sit with forearm supported on a table",
                "Hold hand with palm facing up",
                "Gently bend wrist upward",
                "Hold for 2-3 seconds",
                "Return to starting position slowly"
            ],
            "Finger Squeeze & Open": [
                "Hold hand in front of you",
                "Make tight fist",
                "Hold for 2 seconds",
                "Fully extend fingers",
                "Repeat slowly"
            ],
            "Squat": [
                "Stand with feet shoulder-width apart",
                "Bend knees and hips as if sitting back",
                "Keep back straight",
                "Go as low as comfortable",
                "Return to standing position"
            ]
        };

        // Check if in training mode
        const urlParams = new URLSearchParams(window.location.search);
        const isTrainingMode = urlParams.get('mode') === 'training';

        if (isTrainingMode) {
            // Load patient's custom exercise program
            const patientId = localStorage.getItem('session_patient_id');
            const patientName = localStorage.getItem('session_patient_name');
            
            if (patientId && patientName) {
                // Update header
                const header = document.querySelector('header h1');
                if (header) {
                    header.textContent = `Patient Mode - ${patientName}`;
                }
                
                // Load patient's exercises from localStorage
                const patients = JSON.parse(localStorage.getItem('rehab_patients')) || [];
                const patient = patients.find(p => p.id === patientId);
                
                if (patient && patient.exercises && patient.exercises.length > 0) {
                    // Override the default exercises with patient's custom program
                    const customExercises = {};
                    
                    // Group exercises by body part
                    patient.exercises.forEach(exercise => {
                        let bodyPart = 'upper'; // Default
                        
                        // Map exercise types to body parts
                        if (exercise.type.includes('neck')) bodyPart = 'neck';
                        else if (exercise.type.includes('wrist') || exercise.type.includes('finger')) bodyPart = 'hand';
                        else if (exercise.type.includes('squat')) bodyPart = 'lower';
                        
                        if (!customExercises[bodyPart]) {
                            customExercises[bodyPart] = [];
                        }
                        
                        customExercises[bodyPart].push({
                            id: exercise.type,
                            name: getExerciseName(exercise.type),
                            model: getExerciseModel(exercise.type),
                            reps: exercise.reps,
                            sets: exercise.sets,
                            instructions: exercise.instructions || getDefaultInstructions(exercise.type),
                            side: 'both'
                        });
                    });
                    
                    // Merge with default exercises where needed
                    Object.keys(exercises).forEach(bodyPart => {
                        if (!customExercises[bodyPart]) {
                            customExercises[bodyPart] = exercises[bodyPart];
                        }
                    });
                    
                    // Replace exercises object
                    Object.assign(exercises, customExercises);
                    
                    addFeedback(`Loaded ${patientName}'s custom exercise program`, 'good');
                }
            }
        }

        // Helper functions
        function getExerciseName(type) {
            const names = {
                'neck_flexion': 'Neck Flexion & Extension',
                'neck_rotation': 'Neck Rotation',
                'shoulder_abduction': 'Shoulder Abduction',
                'shoulder_flexion': 'Shoulder Flexion',
                'elbow_flexion': 'Elbow Flexion & Extension',
                'wrist_flexion': 'Wrist Flexion & Extension',
                'finger_flexion': 'Finger Squeeze & Open',
                'squat': 'Squat'
            };
            return names[type] || type;
        }

        function getExerciseModel(type) {
            if (type.includes('neck')) return 'face';
            if (type.includes('wrist') || type.includes('finger')) return 'hands';
            return 'pose';
        }

        function getDefaultInstructions(type) {
            const instructions = {
                'neck_flexion': 'Slowly bend head forward and backward through full range.',
                'neck_rotation': 'Turn head left and right, keeping shoulders stable.',
                'shoulder_abduction': 'Raise arms sideways to shoulder height.',
                'shoulder_flexion': 'Raise arms forward to shoulder height.',
                'elbow_flexion': 'Bend and straighten elbow completely.',
                'wrist_flexion': 'Bend wrist forward and backward.',
                'finger_flexion': 'Make tight fist, then fully extend fingers.',
                'squat': 'Bend knees and hips as if sitting, then stand.'
            };
            return instructions[type] || 'Perform exercise with controlled movements.';
        }

        // Updated Exercise Database with only specified exercises
        const exercises = {
            neck: [
                { 
                    id: 'neck_flexion', 
                    name: 'Neck Flexion & Extension', 
                    model: 'face', 
                    reps: 10, 
                    sets: 3,
                    instructions: 'Slowly bend head forward (chin to chest), then gently tilt backward looking up. Repeat.',
                    side: 'both',
                    landmarks: {
                        flexionThreshold: 0.15,
                        extensionThreshold: 0.05
                    }
                },
                { 
                    id: 'neck_rotation', 
                    name: 'Neck Rotation', 
                    model: 'face', 
                    reps: 10, 
                    sets: 3,
                    instructions: 'Slowly turn head to left side, return to center, then turn to right side. Keep shoulders relaxed.',
                    side: 'both',
                    landmarks: {
                        rotationThreshold: 0.05
                    }
                }
            ],
            upper: [
                { 
                    id: 'shoulder_abduction', 
                    name: 'Shoulder Abduction', 
                    model: 'pose', 
                    reps: 12, 
                    sets: 3,
                    instructions: 'Raise arms sideways to shoulder height, palms facing down. Slowly lower back down.',
                    side: 'both',
                    landmarks: {
                        minAngle: 10,
                        maxAngle: 80
                    }
                },
                { 
                    id: 'shoulder_flexion', 
                    name: 'Shoulder Flexion', 
                    model: 'pose', 
                    reps: 12, 
                    sets: 3,
                    instructions: 'Raise arms forward to shoulder height, palms facing each other. Slowly lower back down.',
                    side: 'both',
                    landmarks: {
                        minAngle: 10,
                        maxAngle: 80
                    }
                },
                { 
                    id: 'elbow_flexion', 
                    name: 'Elbow Flexion & Extension', 
                    model: 'pose', 
                    reps: 15, 
                    sets: 3,
                    instructions: 'Bend elbow bringing hand to shoulder, then straighten arm completely.',
                    side: 'both',
                    landmarks: {
                        minAngle: 30,
                        maxAngle: 160
                    }
                }
            ],
            hand: [
                { 
                    id: 'wrist_flexion', 
                    name: 'Wrist Flexion & Extension', 
                    model: 'hands', 
                    reps: 15, 
                    sets: 3,
                    instructions: 'Bend wrist forward and backward through full range. Keep forearm supported.',
                    side: 'both',
                    landmarks: {
                        flexionThreshold: 30,
                        extensionThreshold: -20
                    }
                },
                { 
                    id: 'finger_flexion', 
                    name: 'Finger Squeeze & Open', 
                    model: 'hands', 
                    reps: 20, 
                    sets: 3,
                    instructions: 'Make tight fist, hold for 2 seconds, then fully extend fingers.',
                    side: 'both',
                    landmarks: {
                        closedThreshold: 0.15,
                        openThreshold: 0.25
                    }
                }
            ],
            lower: [
                { 
                    id: 'squat', 
                    name: 'Squat', 
                    model: 'pose', 
                    reps: 10, 
                    sets: 3,
                    instructions: 'Stand with feet shoulder-width apart. Bend knees and hips as if sitting back into a chair, then return to standing.',
                    side: 'both',
                    landmarks: {
                        minAngle: 70,
                        maxAngle: 170
                    }
                }
            ]
        };

        // Variables
        let isTracking = false;
        let isExerciseActive = false;
        let currentStream = null;
        let ctx = null;
        let selectedBodyPart = 'neck';
        let selectedExercise = null;
        let activeModel = 'face';

        // MediaPipe Models
        let pose = null;
        let hands = null;
        let faceMesh = null;
        let camera = null;

        // Session Data
        let sessionData = {
            startTime: null,
            reps: 0,
            formScore: 100,
            feedback: [],
            lastRepTime: 0,
            currentState: 'start',
            currentSide: 'right',
            repHistory: []
        };

        // Session recording variables
        let sessionStartTime = null;
        let totalReps = 0;
        let formScores = [];
        let sessionDuration = 0;
        let isSessionActive = false;
        let sessionTimer = null;
        let elapsedSeconds = 0;

        // ===== VIDEO GUIDANCE FUNCTIONS =====

        // Function to show video guidance
        function showVideoGuidance(exerciseName) {
            currentVideoExercise = exerciseName;
            
            // Get video filename
            let videoFile = exerciseVideos[exerciseName];
            if (!videoFile) {
                // Use default based on body part
                const currentBody = document.querySelector('.body-option.active').dataset.body;
                videoFile = defaultVideos[currentBody] || "general_exercise.mp4";
            }
            
            // Update UI
            document.getElementById('videoExerciseTitle').textContent = `${exerciseName} - Guidance Video`;
            
            // Set video source
            const videoElement = document.getElementById('guidanceVideo');
            const sourceElement = document.getElementById('videoSource');
            
            // Try to load video from local folder
            sourceElement.src = videoFile;
            videoElement.load();
            
            // Set instructions
            const instructions = exerciseInstructionsMap[exerciseName] || [
                "Watch the video demonstration carefully",
                "Pay attention to the correct form and posture",
                "Perform movements slowly and with control",
                "Stop if you feel any sharp pain",
                "Focus on quality rather than speed"
            ];
            
            const instructionsList = document.getElementById('videoInstructionsList');
            instructionsList.innerHTML = instructions.map(inst => `<li>${inst}</li>`).join('');
            
            // Show popup
            document.getElementById('videoGuidanceOverlay').classList.add('active');
            
            // Start auto-close countdown
            startAutoCloseCountdown();
            
            // Play video automatically
            setTimeout(() => {
                videoElement.play().catch(e => {
                    console.log("Auto-play prevented, user must click play");
                });
            }, 500);
        }

        // Function to start auto-close countdown
        function startAutoCloseCountdown() {
            let timeLeft = autoCloseTime;
            const countdownElement = document.getElementById('countdownTimer');
            const noticeElement = document.getElementById('autoCloseNotice');
            
            // Reset countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownElement.textContent = timeLeft;
            noticeElement.style.display = 'block';
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    closeVideoGuidance();
                }
            }, 1000);
        }

        // Function to close video guidance
        function closeVideoGuidance() {
            const videoElement = document.getElementById('guidanceVideo');
            const overlay = document.getElementById('videoGuidanceOverlay');
            
            // Pause video
            videoElement.pause();
            
            // Hide overlay
            overlay.classList.remove('active');
            
            // Clear countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // Start the actual exercise tracking
            startActualExerciseSession();
        }

        // Video control functions
        function setupVideoControls() {
            const videoElement = document.getElementById('guidanceVideo');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const replayBtn = document.getElementById('replayBtn');
            const skipBtn = document.getElementById('skipVideoBtn');
            const closeBtn = document.getElementById('closeVideoBtn');
            
            if (!videoElement || !playPauseBtn) return;
            
            // Play/Pause button
            playPauseBtn.addEventListener('click', () => {
                if (videoElement.paused) {
                    videoElement.play();
                    playPauseBtn.innerHTML = '<span>‚è∏</span> Pause Video';
                    playPauseBtn.classList.add('pause');
                } else {
                    videoElement.pause();
                    playPauseBtn.innerHTML = '<span>‚ñ∂</span> Play Video';
                    playPauseBtn.classList.remove('pause');
                }
            });
            
            // Replay button
            replayBtn.addEventListener('click', () => {
                videoElement.currentTime = 0;
                videoElement.play();
                playPauseBtn.innerHTML = '<span>‚è∏</span> Pause Video';
                playPauseBtn.classList.add('pause');
                
                // Reset countdown
                startAutoCloseCountdown();
            });
            
            // Skip button
            skipBtn.addEventListener('click', () => {
                closeVideoGuidance();
            });
            
            // Close button
            closeBtn.addEventListener('click', () => {
                closeVideoGuidance();
            });
            
            // Video events
            videoElement.addEventListener('play', () => {
                isVideoPlaying = true;
                playPauseBtn.innerHTML = '<span>‚è∏</span> Pause Video';
                playPauseBtn.classList.add('pause');
            });
            
            videoElement.addEventListener('pause', () => {
                isVideoPlaying = false;
                playPauseBtn.innerHTML = '<span>‚ñ∂</span> Play Video';
                playPauseBtn.classList.remove('pause');
            });
            
            videoElement.addEventListener('ended', () => {
                playPauseBtn.innerHTML = '<span>‚ñ∂</span> Play Again';
                playPauseBtn.classList.remove('pause');
            });
        }

        // Function to get selected exercise
        function getSelectedExercise() {
            const activeExercise = document.querySelector('.exercise-item.active');
            if (activeExercise) {
                const exerciseId = activeExercise.dataset.id;
                const bodyExercises = exercises[selectedBodyPart] || [];
                const exercise = bodyExercises.find(ex => ex.id === exerciseId);
                return exercise;
            }
            return null;
        }

        // ===== SESSION RECORDING FUNCTIONS =====

        // Function to start session recording
        function startSessionRecording() {
            if (!selectedExercise) return;
            
            sessionStartTime = new Date();
            totalReps = 0;
            formScores = [];
            isSessionActive = true;
            sessionData.reps = 0;
            sessionData.formScore = 100;
            elapsedSeconds = 0;
            
            console.log(`Session started for: ${selectedExercise.name} at ${sessionStartTime}`);
            
            // Start session timer
            updateTimer();
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            sessionTimer = setInterval(() => {
                elapsedSeconds++;
                updateTimer();
            }, 1000);
        }

        // Function to add rep with form score
        function addRep(formScore) {
            if (!isSessionActive) return;
            
            totalReps++;
            formScores.push(formScore);
            sessionData.reps = totalReps;
            
            // Update UI
            updateRepCount();
            
            // Calculate average form score
            const avgScore = formScores.length > 0 
                ? Math.round(formScores.reduce((a, b) => a + b, 0) / formScores.length)
                : 100;
            sessionData.formScore = avgScore;
            
            console.log(`Rep ${totalReps} added with score: ${formScore}%`);
        }

        // Function to end and save session
        function endSessionRecording() {
            if (!isSessionActive || !sessionStartTime) return;
            
            isSessionActive = false;
            const endTime = new Date();
            
            if (!selectedExercise) return;
            
            // Calculate session statistics
            const avgFormScore = formScores.length > 0 
                ? Math.round(formScores.reduce((a, b) => a + b, 0) / formScores.length)
                : 0;
            
            const durationMinutes = (elapsedSeconds / 60).toFixed(1);
            
            // Generate feedback based on performance
            const feedback = generateSessionFeedback(avgFormScore, totalReps);
            
            // Create session data object
            const sessionData = {
                exercise: selectedExercise.name,
                date: sessionStartTime.toISOString().split('T')[0],
                duration: durationMinutes,
                reps: totalReps,
                sets: 1,
                accuracy: avgFormScore,
                feedback: feedback,
                painLevel: 2,
                difficulty: "Medium",
                timestamp: endTime.toISOString()
            };
            
            // Save session to progress storage
            saveSessionToProgress(sessionData);
            
            // Reset session variables
            resetSessionVariables();
            
            // Show success message
            showSessionCompleteMessage(sessionData);
        }

        // Function to save session to progress storage
        function saveSessionToProgress(sessionData) {
            try {
                // Get current user
                const savedUser = localStorage.getItem('rehabUser');
                if (!savedUser) {
                    console.error("No user logged in");
                    return false;
                }
                
                const currentUser = JSON.parse(savedUser);
                
                // Check if progressStorage exists
                if (typeof progressStorage !== 'undefined') {
                    progressStorage.addSession({
                        username: currentUser.username,
                        ...sessionData
                    });
                    console.log("Session saved to progress storage");
                    return true;
                } else {
                    // Fallback to localStorage
                    saveSessionToLocalStorage(currentUser.username, sessionData);
                    console.log("Session saved to localStorage");
                    return true;
                }
            } catch (error) {
                console.error("Error saving session:", error);
                return false;
            }
        }

        // Fallback function to save to localStorage
        function saveSessionToLocalStorage(username, sessionData) {
            const storageKey = 'rehab_sessions_' + username;
            let sessions = [];
            
            try {
                const saved = localStorage.getItem(storageKey);
                if (saved) {
                    sessions = JSON.parse(saved);
                }
                
                sessions.push({
                    id: Date.now().toString(),
                    username: username,
                    ...sessionData
                });
                
                localStorage.setItem(storageKey, JSON.stringify(sessions));
            } catch (error) {
                console.error("Error saving to localStorage:", error);
            }
        }

        // Function to generate feedback based on performance
        function generateSessionFeedback(avgScore, totalReps) {
            if (avgScore >= 90) {
                return "Excellent form! Perfect technique maintained throughout.";
            } else if (avgScore >= 80) {
                return "Good form! Minor adjustments needed in posture.";
            } else if (avgScore >= 70) {
                return "Fair form. Focus on maintaining correct posture.";
            } else if (avgScore >= 60) {
                return "Needs improvement. Pay attention to exercise technique.";
            } else {
                return "Poor form detected. Please review the guidance video.";
            }
        }

        // Function to reset session variables
        function resetSessionVariables() {
            sessionStartTime = null;
            totalReps = 0;
            formScores = [];
            sessionDuration = 0;
            isSessionActive = false;
            
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
            
            // Reset UI
            repCount.textContent = '0';
            sessionTime.textContent = '0:00';
            formScore.textContent = '100%';
            elapsedSeconds = 0;
        }

        // ===== PATIENT NAME ENTRY FUNCTIONS =====

        let currentPatientInfo = null;

        // Function to show session completion message
        // Enhanced session saving with patient info
        function saveSessionWithPatientInfo(sessionData) {
            try {
                // Get patient info from current session
                let patientInfo = JSON.parse(localStorage.getItem('currentPatientInfo'));
                if (!patientInfo) {
                    console.warn('No patient info found, using current user');
                    const savedUser = localStorage.getItem('rehabUser');
                    if (!savedUser) return false;
                    patientInfo = JSON.parse(savedUser);
                }
                
                // Add patient info to session data
                const enhancedSession = {
                    ...sessionData,
                    patientName: patientInfo.name,
                    patientCondition: patientInfo.condition || 'General',
                    patientAge: patientInfo.age || 'Not specified',
                    patientNotes: patientInfo.notes || ''
                };
                
                // Save to progress storage
                if (typeof progressStorage !== 'undefined') {
                    progressStorage.addSession({
                        username: patientInfo.username || patientInfo.name.toLowerCase().replace(/\s+/g, '_'),
                        ...enhancedSession
                    });
                } else {
                    saveSessionToLocalStorage(
                        patientInfo.username || patientInfo.name.toLowerCase().replace(/\s+/g, '_'),
                        enhancedSession
                    );
                }
                
                console.log("Session saved with patient info");
                return true;
            } catch (error) {
                console.error("Error saving session with patient info:", error);
                return false;
            }
        }

        // Update the session saving in patient-script.js
        function saveSessionToProgress(sessionData) {
            // Use the enhanced function
            return saveSessionWithPatientInfo(sessionData);
        }

        // ===== EXERCISE TRACKING FUNCTIONS =====

        // Function to start exercise tracking (shows video first)
        function startExerciseSessionWithVideo() {
            const exercise = getSelectedExercise();
            if (!exercise) {
                addFeedback('Please select an exercise first', 'error');
                return;
            }
            
            console.log("Starting exercise with video guidance:", exercise.name);
            
            // Show video guidance
            showVideoGuidance(exercise.name);
        }

        // Function to start actual exercise session (after video)
        function startActualExerciseSession() {
            if (!selectedExercise) {
                addFeedback('Please select an exercise first', 'error');
                return;
            }
            
            isTracking = true;
            isExerciseActive = true;
            startExerciseBtn.disabled = true;
            pauseExerciseBtn.disabled = false;
            endSessionBtn.disabled = false;
            
            resetSessionVariables();
            startSessionRecording();
            
            addFeedback(`Started ${selectedExercise.name} session`, 'good');
            addFeedback(`Using ${activeModel.toUpperCase()} model for detection`, 'info');
            
            // Start the appropriate camera pipeline
            startCameraPipeline();
        }

        // ===== MEDIAPIPE FUNCTIONS =====

        // Add this to help debug
        function debugFaceMesh() {
            console.log('FaceMesh model status:', {
                isDefined: typeof faceMesh !== 'undefined',
                hasSend: faceMesh && typeof faceMesh.send === 'function',
                activeModel: activeModel,
                selectedExercise: selectedExercise
            });
        }

        // Initialize all MediaPipe models
        async function initializeModels() {
            try {
                // Initialize Pose model
                pose = new window.Pose({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
                });
                pose.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                pose.onResults(onPoseResults);
                
                // Initialize Hands model
                hands = new window.Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                });
                hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                hands.onResults(onHandsResults);
                
                // Initialize Face Mesh model
                faceMesh = new window.FaceMesh({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
                });
                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                faceMesh.onResults(onFaceResults);
                
                addFeedback('AI models initialized successfully!', 'good');
                return true;
            } catch (error) {
                console.error('Error initializing models:', error);
                addFeedback('Error initializing AI models', 'error');
                debugFaceMesh();
                return false;
            }
        }

        // Start webcam
        async function startWebcam() {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                video.srcObject = currentStream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.width = video.videoWidth;
                        video.height = video.videoHeight;
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx = canvas.getContext('2d');
                        resolve(true);
                    };
                });
            } catch (error) {
                console.error('Error accessing webcam:', error);
                addFeedback('Error accessing camera. Please check permissions.', 'error');
                return false;
            }
        }

        // Process Pose results
        function onPoseResults(results) {
            if (!ctx || !isTracking || activeModel !== 'pose') return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw video frame
            ctx.save();
            ctx.scale(-1, 1);
            ctx.translate(-canvas.width, 0);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.restore();
            
            if (results.poseLandmarks) {
                drawPoseLandmarks(results.poseLandmarks);
                analyzePoseExercise(results.poseLandmarks);
            }
        }

        // Process Hands results
        function onHandsResults(results) {
            if (!ctx || !isTracking || activeModel !== 'hands') return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw video frame
            ctx.save();
            ctx.scale(-1, 1);
            ctx.translate(-canvas.width, 0);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.restore();
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                drawHandLandmarks(results.multiHandLandmarks, results.multiHandedness);
                analyzeHandExercise(results.multiHandLandmarks);
            }
        }

        // Process Face results
        function onFaceResults(results) {
            try {
                if (!ctx || !isTracking || activeModel !== 'face') return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw video frame
                ctx.save();
                ctx.scale(-1, 1);
                ctx.translate(-canvas.width, 0);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.restore();
                
                // Check if results and landmarks exist
                if (results && results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    if (landmarks && landmarks.length > 0) {
                        drawFaceLandmarks(results.multiFaceLandmarks);
                        if (isExerciseActive) {
                            analyzeFaceExercise(results.multiFaceLandmarks);
                        }
                    }
                } else {
                    // Add feedback when no face is detected
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                    ctx.fillRect(10, 10, 300, 40);
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.fillText('No face detected. Move to center.', 20, 35);
                }
            } catch (error) {
                console.error('Error in onFaceResults:', error);
            }
        }

        // ===== DRAWING FUNCTIONS =====

        // Draw Pose landmarks
        function drawPoseLandmarks(landmarks) {
            // Draw connections
            ctx.strokeStyle = '#00f2fe';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            const connections = [
                [11, 12], [11, 13], [13, 15], [12, 14], [14, 16], // Shoulders to hands
                [11, 23], [12, 24], [23, 24], [23, 25], [25, 27], // Torso to legs
                [24, 26], [26, 28], [27, 29], [28, 30], [29, 31], [30, 32] // Legs to feet
            ];
            
            connections.forEach(conn => {
                const [start, end] = conn;
                if (landmarks[start] && landmarks[end]) {
                    const startX = canvas.width - (landmarks[start].x * canvas.width);
                    const startY = landmarks[start].y * canvas.height;
                    const endX = canvas.width - (landmarks[end].x * canvas.width);
                    const endY = landmarks[end].y * canvas.height;
                    
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }
            });
            
            // Draw key landmarks for our exercises
            const keyPoints = [11, 12, 13, 14, 15, 16, 23, 24, 25, 26]; // Shoulders, elbows, wrists, hips, knees
            
            keyPoints.forEach(index => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, 2 * Math.PI);
                    ctx.fillStyle = '#4776E6';
                    ctx.fill();
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });
        }

        // Draw Hand landmarks
        function drawHandLandmarks(handLandmarks, handedness) {
            handLandmarks.forEach((landmarks, handIndex) => {
                const isRightHand = handedness[handIndex].label === 'Right';
                
                // Draw connections
                ctx.strokeStyle = isRightHand ? '#43e97b' : '#fa709a';
                ctx.lineWidth = 2;
                
                // Hand connections
                const connections = [
                    [0, 1], [1, 2], [2, 3], [3, 4], // Thumb
                    [0, 5], [5, 6], [6, 7], [7, 8], // Index finger
                    [0, 9], [9, 10], [10, 11], [11, 12], // Middle finger
                    [0, 13], [13, 14], [14, 15], [15, 16], // Ring finger
                    [0, 17], [17, 18], [18, 19], [19, 20] // Pinky
                ];
                
                connections.forEach(conn => {
                    const [start, end] = conn;
                    if (landmarks[start] && landmarks[end]) {
                        const startX = canvas.width - (landmarks[start].x * canvas.width);
                        const startY = landmarks[start].y * canvas.height;
                        const endX = canvas.width - (landmarks[end].x * canvas.width);
                        const endY = landmarks[end].y * canvas.height;
                        
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX, endY);
                        ctx.stroke();
                    }
                });
                
                // Draw landmarks
                landmarks.forEach((landmark, index) => {
                    const x = canvas.width - (landmark.x * canvas.width);
                    const y = landmark.y * canvas.height;
                    
                    let radius = 3;
                    if (index === 0) radius = 6; // Wrist
                    if ([4, 8, 12, 16, 20].includes(index)) radius = 5; // Fingertips
                    
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = isRightHand ? '#43e97b' : '#fa709a';
                    ctx.fill();
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                });
            });
        }

        // Draw Face landmarks
        function drawFaceLandmarks(faceLandmarks) {
            if (!faceLandmarks || faceLandmarks.length === 0) return;
            
            const landmarks = faceLandmarks[0];
            if (!landmarks || landmarks.length === 0) return;
            
            // Draw all 468 landmarks as small dots with circular arrangement
            ctx.fillStyle = 'rgba(255, 100, 200, 0.6)';
            
            // Draw facial mesh with circular connections
            drawFacialMesh(landmarks);
            
            // Draw face outline (oval shape)
            drawFaceOutline(landmarks);
            
            // Draw eyes with circular connections
            drawEyes(landmarks);
            
            // Draw mouth with circular shape
            drawMouth(landmarks);
            
            // Draw eyebrows
            drawEyebrows(landmarks);
            
            // Draw nose with circular shape
            drawNose(landmarks);
        }

        // Helper function to draw facial mesh with circular patterns
        function drawFacialMesh(landmarks) {
            // Draw all 468 landmarks as small dots
            ctx.fillStyle = 'rgba(255, 100, 200, 0.4)';
            for (let i = 0; i < landmarks.length; i++) {
                const landmark = landmarks[i];
                const x = canvas.width - (landmark.x * canvas.width);
                const y = landmark.y * canvas.height;
                
                // Vary dot size based on landmark importance
                let size = 1.5;
                if (i % 50 === 0) size = 3; // Key points
                if ([1, 33, 263, 61, 291, 199].includes(i)) size = 4; // Critical points
                
                ctx.beginPath();
                ctx.arc(x, y, size, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // Draw circular connections between key points
            ctx.strokeStyle = 'rgba(255, 100, 200, 0.3)';
            ctx.lineWidth = 1;
            
            // Circular connections around face
            const circularGroups = [
                // Forehead circle
                [10, 338, 297, 332, 284],
                // Cheek circles
                [116, 117, 118, 119, 120, 121],
                [346, 347, 348, 349, 350, 351],
                // Chin circle
                [175, 148, 152, 377, 400, 378, 379],
            ];
            
            circularGroups.forEach(group => {
                ctx.beginPath();
                group.forEach((index, i) => {
                    if (landmarks[index]) {
                        const x = canvas.width - (landmarks[index].x * canvas.width);
                        const y = landmarks[index].y * canvas.height;
                        
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                });
                ctx.closePath();
                ctx.stroke();
            });
        }

        // Draw face outline (oval shape)
        function drawFaceOutline(landmarks) {
            ctx.strokeStyle = '#fa709a';
            ctx.lineWidth = 2;
            
            // Face oval indices (MediaPipe standard)
            const faceOval = [
                10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 
                361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 
                176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 
                162, 21, 54, 103, 67, 109
            ];
            
            ctx.beginPath();
            faceOval.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.stroke();
        }

        // Draw eyes with circular connections
        function drawEyes(landmarks) {
            // Left eye (circular)
            const leftEyeIndices = [
                33, 7, 163, 144, 145, 153, 154, 155, 133, 
                173, 157, 158, 159, 160, 161, 246
            ];
            
            // Right eye (circular)
            const rightEyeIndices = [
                362, 382, 381, 380, 374, 373, 390, 249, 
                263, 466, 388, 387, 386, 385, 384, 398
            ];
            
            ctx.strokeStyle = '#4facfe';
            ctx.lineWidth = 1.5;
            
            // Draw left eye
            ctx.beginPath();
            leftEyeIndices.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.stroke();
            
            // Draw right eye
            ctx.beginPath();
            rightEyeIndices.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.stroke();
        }

        // Draw mouth with circular shape
        function drawMouth(landmarks) {
            // Outer mouth (lip contour)
            const outerMouth = [
                61, 185, 40, 39, 37, 0, 267, 269, 270, 409, 
                291, 375, 321, 405, 314, 17, 84, 181, 91, 146
            ];
            
            // Inner mouth
            const innerMouth = [
                78, 95, 88, 178, 87, 14, 317, 402, 318, 324, 
                308, 191, 80, 81, 82, 13, 312, 311, 310, 415
            ];
            
            ctx.strokeStyle = '#ff5858';
            ctx.lineWidth = 1.5;
            
            // Draw outer mouth
            ctx.beginPath();
            outerMouth.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.stroke();
            
            // Draw inner mouth
            ctx.beginPath();
            innerMouth.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.stroke();
        }

        // Draw eyebrows
        function drawEyebrows(landmarks) {
            // Left eyebrow
            const leftEyebrow = [70, 63, 105, 66, 107, 55, 65, 52, 53, 46];
            // Right eyebrow
            const rightEyebrow = [300, 293, 334, 296, 336, 285, 295, 282, 283, 276];
            
            ctx.strokeStyle = '#8E54E9';
            ctx.lineWidth = 1.5;
            
            // Draw left eyebrow
            ctx.beginPath();
            leftEyebrow.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw right eyebrow
            ctx.beginPath();
            rightEyebrow.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
        }

        // Draw nose with circular shape
        function drawNose(landmarks) {
            // Nose bridge and tip
            const noseBridge = [168, 6, 197, 195, 5, 4, 1, 19, 94];
            const noseTip = [1, 2, 98, 327, 326, 2, 97, 326, 327, 294];
            const noseWings = [129, 49, 131, 358, 357, 350, 348, 347, 330];
            
            ctx.strokeStyle = '#43e97b';
            ctx.lineWidth = 1.5;
            
            // Draw nose bridge
            ctx.beginPath();
            noseBridge.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw nose tip circle
            ctx.beginPath();
            noseTip.forEach((index, i) => {
                if (landmarks[index]) {
                    const x = canvas.width - (landmarks[index].x * canvas.width);
                    const y = landmarks[index].y * canvas.height;
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.stroke();
        }

        // ===== EXERCISE ANALYSIS FUNCTIONS =====

        // Analyze pose-based exercises
        function analyzePoseExercise(landmarks) {
            if (!selectedExercise || !isExerciseActive) return;
            
            switch(selectedExercise.id) {
                case 'shoulder_abduction':
                    analyzeShoulderAbduction(landmarks);
                    break;
                case 'shoulder_flexion':
                    analyzeShoulderFlexion(landmarks);
                    break;
                case 'elbow_flexion':
                    analyzeElbowFlexionExtension(landmarks);
                    break;
                case 'squat':
                    analyzeSquat(landmarks);
                    break;
            }
        }

        // Analyze hand-based exercises
        function analyzeHandExercise(handLandmarks) {
            if (!selectedExercise || !isExerciseActive || handLandmarks.length === 0) return;
            
            const landmarks = handLandmarks[0];
            
            switch(selectedExercise.id) {
                case 'wrist_flexion':
                    analyzeWristFlexionExtension(landmarks);
                    break;
                case 'finger_flexion':
                    analyzeFingerFlexion(landmarks);
                    break;
            }
        }

        // Analyze face/neck-based exercises
        function analyzeFaceExercise(faceLandmarks) {
            if (!selectedExercise || !isExerciseActive || faceLandmarks.length === 0) return;
            
            const landmarks = faceLandmarks[0];
            
            switch(selectedExercise.id) {
                case 'neck_flexion':
                    analyzeNeckFlexionExtension(landmarks);
                    break;
                case 'neck_rotation':
                    analyzeNeckRotation(landmarks);
                    break;
            }
        }

        // Exercise Analysis Functions

        function analyzeShoulderAbduction(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            
            if (leftShoulder && leftWrist) {
                const leftAngle = Math.atan2(leftWrist.y - leftShoulder.y, leftWrist.x - leftShoulder.x) * (180 / Math.PI);
                
                if (Math.abs(leftAngle) > 80 && sessionData.currentState !== 'raised') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(90); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Left shoulder abduction detected!', 'good');
                        sessionData.currentSide = 'left';
                    }
                    sessionData.currentState = 'raised';
                } else if (Math.abs(leftAngle) < 20 && sessionData.currentState === 'raised') {
                    sessionData.currentState = 'lowered';
                }
            }
            
            if (rightShoulder && rightWrist) {
                const rightAngle = Math.atan2(rightWrist.y - rightShoulder.y, rightWrist.x - rightShoulder.x) * (180 / Math.PI);
                
                if (Math.abs(rightAngle) > 80 && sessionData.currentState !== 'raised') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(90); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Right shoulder abduction detected!', 'good');
                        sessionData.currentSide = 'right';
                    }
                    sessionData.currentState = 'raised';
                } else if (Math.abs(rightAngle) < 20 && sessionData.currentState === 'raised') {
                    sessionData.currentState = 'lowered';
                }
            }
        }

        function analyzeShoulderFlexion(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            
            if (leftShoulder && leftWrist) {
                const leftHeightDiff = leftShoulder.y - leftWrist.y;
                
                if (leftHeightDiff > 0.1 && sessionData.currentState !== 'raised') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(85); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Left shoulder flexion detected!', 'good');
                        sessionData.currentSide = 'left';
                    }
                    sessionData.currentState = 'raised';
                } else if (leftHeightDiff < 0.02 && sessionData.currentState === 'raised') {
                    sessionData.currentState = 'lowered';
                }
            }
            
            if (rightShoulder && rightWrist) {
                const rightHeightDiff = rightShoulder.y - rightWrist.y;
                
                if (rightHeightDiff > 0.1 && sessionData.currentState !== 'raised') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(85); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Right shoulder flexion detected!', 'good');
                        sessionData.currentSide = 'right';
                    }
                    sessionData.currentState = 'raised';
                } else if (rightHeightDiff < 0.02 && sessionData.currentState === 'raised') {
                    sessionData.currentState = 'lowered';
                }
            }
        }

        function analyzeElbowFlexionExtension(landmarks) {
            const leftShoulder = landmarks[11];
            const leftElbow = landmarks[13];
            const leftWrist = landmarks[15];
            const rightShoulder = landmarks[12];
            const rightElbow = landmarks[14];
            const rightWrist = landmarks[16];
            
            // Check left arm
            if (leftShoulder && leftElbow && leftWrist) {
                const leftAngle = calculateAngle(leftShoulder, leftElbow, leftWrist);
                
                if (leftAngle < 60 && sessionData.currentState !== 'flexed') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(88); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Left elbow flexion detected!', 'good');
                        sessionData.currentSide = 'left';
                    }
                    sessionData.currentState = 'flexed';
                } else if (leftAngle > 150 && sessionData.currentState === 'flexed') {
                    sessionData.currentState = 'extended';
                }
            }
            
            // Check right arm
            if (rightShoulder && rightElbow && rightWrist) {
                const rightAngle = calculateAngle(rightShoulder, rightElbow, rightWrist);
                
                if (rightAngle < 60 && sessionData.currentState !== 'flexed') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(88); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Right elbow flexion detected!', 'good');
                        sessionData.currentSide = 'right';
                    }
                    sessionData.currentState = 'flexed';
                } else if (rightAngle > 150 && sessionData.currentState === 'flexed') {
                    sessionData.currentState = 'extended';
                }
            }
        }

        function analyzeSquat(landmarks) {
            const leftHip = landmarks[23];
            const leftKnee = landmarks[25];
            const leftAnkle = landmarks[27];
            const rightHip = landmarks[24];
            const rightKnee = landmarks[26];
            const rightAnkle = landmarks[28];
            
            if (leftHip && leftKnee && leftAnkle) {
                const leftAngle = calculateAngle(leftHip, leftKnee, leftAnkle);
                
                if (leftAngle < 100 && sessionData.currentState !== 'squatted') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(92); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Squat detected! Good depth!', 'good');
                    }
                    sessionData.currentState = 'squatted';
                } else if (leftAngle > 160 && sessionData.currentState === 'squatted') {
                    sessionData.currentState = 'standing';
                }
            }
        }

        function analyzeWristFlexionExtension(handLandmarks) {
            const wrist = handLandmarks[0];
            const middleMCP = handLandmarks[9];
            
            if (wrist && middleMCP) {
                const angle = Math.atan2(middleMCP.y - wrist.y, middleMCP.x - wrist.x) * (180 / Math.PI);
                
                if (angle > 30 && sessionData.currentState !== 'flexed') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(86); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Wrist flexion detected!', 'good');
                    }
                    sessionData.currentState = 'flexed';
                } else if (angle < -20 && sessionData.currentState !== 'extended') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(86); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Wrist extension detected!', 'good');
                    }
                    sessionData.currentState = 'extended';
                }
            }
        }

        function analyzeFingerFlexion(handLandmarks) {
            const wrist = handLandmarks[0];
            const fingertips = [4, 8, 12, 16, 20];
            
            let totalDistance = 0;
            fingertips.forEach(index => {
                const tip = handLandmarks[index];
                if (tip && wrist) {
                    const dx = tip.x - wrist.x;
                    const dy = tip.y - wrist.y;
                    totalDistance += Math.sqrt(dx * dx + dy * dy);
                }
            });
            
            const avgDistance = totalDistance / fingertips.length;
            
            if (avgDistance < 0.15 && sessionData.currentState !== 'closed') {
                if (Date.now() - sessionData.lastRepTime > 1000) {
                    addRep(90); // Good form score
                    sessionData.lastRepTime = Date.now();
                    addFeedback('Fist made! Good finger flexion.', 'good');
                }
                sessionData.currentState = 'closed';
            } else if (avgDistance > 0.25 && sessionData.currentState === 'closed') {
                sessionData.currentState = 'open';
            }
        }

        function analyzeNeckFlexionExtension(faceLandmarks) {
            const nose = faceLandmarks[1];
            const chin = faceLandmarks[152];
            
            if (nose && chin) {
                const verticalDistance = chin.y - nose.y;
                
                if (verticalDistance > 0.15 && sessionData.currentState !== 'flexed') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(87); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Neck flexion detected!', 'good');
                    }
                    sessionData.currentState = 'flexed';
                } else if (verticalDistance < 0.05 && sessionData.currentState !== 'extended') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(87); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Neck extension detected!', 'good');
                    }
                    sessionData.currentState = 'extended';
                }
            }
        }

        function analyzeNeckRotation(faceLandmarks) {
            const leftEye = faceLandmarks[33];
            const rightEye = faceLandmarks[263];
            const nose = faceLandmarks[1];
            
            if (leftEye && rightEye && nose) {
                const eyeMidX = (leftEye.x + rightEye.x) / 2;
                const horizontalOffset = nose.x - eyeMidX;
                
                if (horizontalOffset > 0.05 && sessionData.currentState !== 'right') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(89); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Right neck rotation detected!', 'good');
                    }
                    sessionData.currentState = 'right';
                } else if (horizontalOffset < -0.05 && sessionData.currentState !== 'left') {
                    if (Date.now() - sessionData.lastRepTime > 1000) {
                        addRep(89); // Good form score
                        sessionData.lastRepTime = Date.now();
                        addFeedback('Left neck rotation detected!', 'good');
                    }
                    sessionData.currentState = 'left';
                }
            }
        }

        function calculateAngle(a, b, c) {
            const ab = { x: b.x - a.x, y: b.y - a.y };
            const cb = { x: b.x - c.x, y: b.y - c.y };
            
            const dot = (ab.x * cb.x + ab.y * cb.y);
            const cross = (ab.x * cb.y - ab.y * cb.x);
            
            let angle = Math.atan2(cross, dot);
            angle = (angle * 180) / Math.PI;
            return Math.abs(angle);
        }

        // ===== UI UPDATE FUNCTIONS =====

        function updateRepCount() {
            repCount.textContent = sessionData.reps;
            
            // Update form score
            const errorCount = sessionData.feedback.filter(f => f.type === 'warning' || f.type === 'error').length;
            const newScore = Math.max(70, 100 - (errorCount * 2));
            sessionData.formScore = newScore;
            formScore.textContent = `${newScore}%`;
        }

        function addFeedback(message, type = 'info') {
            const feedbackItem = document.createElement('div');
            feedbackItem.className = `feedback-item ${type}`;
            feedbackItem.textContent = `[${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}] ${message}`;
            
            feedbackList.appendChild(feedbackItem);
            feedbackList.scrollTop = feedbackList.scrollHeight;
            
            // Keep only last 10 feedback items
            const items = feedbackList.querySelectorAll('.feedback-item');
            if (items.length > 10) {
                items[0].remove();
            }
            
            sessionData.feedback.push({
                time: new Date().toISOString(),
                message: message,
                type: type
            });
        }

        // Initialize body selection
        function initBodySelection() {
            const bodyOptions = document.querySelectorAll('.body-option');
            bodyOptions.forEach(option => {
                option.addEventListener('click', () => {
                    bodyOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedBodyPart = option.dataset.body;
                    loadExercises(selectedBodyPart);
                });
            });
            
            loadExercises('neck');
        }

        // Load exercises for selected body part
        function loadExercises(bodyPart) {
            exerciseList.innerHTML = '';
            const bodyExercises = exercises[bodyPart] || [];
            
            bodyExercises.forEach(exercise => {
                const exerciseItem = document.createElement('div');
                exerciseItem.className = 'exercise-item';
                exerciseItem.dataset.id = exercise.id;
                exerciseItem.innerHTML = `
                    <div class="exercise-name">${exercise.name}</div>
                    <div>
                        <span class="exercise-model model-${exercise.model}">${exercise.model.toUpperCase()}</span>
                        <span style="font-size: 0.85rem; opacity: 0.8;">${exercise.reps} reps √ó ${exercise.sets} sets</span>
                    </div>
                `;
                
                exerciseItem.addEventListener('click', () => {
                    document.querySelectorAll('.exercise-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    exerciseItem.classList.add('active');
                    selectExercise(exercise);
                });
                
                exerciseList.appendChild(exerciseItem);
            });
            
            if (bodyExercises.length > 0) {
                setTimeout(() => {
                    document.querySelector('.exercise-item').classList.add('active');
                    selectExercise(bodyExercises[0]);
                }, 100);
            }
        }

        // Select an exercise
        function selectExercise(exercise) {
            selectedExercise = exercise;
            activeModel = exercise.model;
            
            // Update model indicator
            if (currentModel) {
                currentModel.textContent = exercise.model.charAt(0).toUpperCase() + exercise.model.slice(1);
            }
            if (modelIndicator) {
                modelIndicator.textContent = `${exercise.model.toUpperCase()} Model Active`;
            }
            
            // Update indicator dot
            const indicatorDot = document.querySelector('.indicator-dot');
            if (indicatorDot) {
                indicatorDot.className = 'indicator-dot';
                indicatorDot.classList.add(`indicator-${exercise.model}`);
            }
            
            // Update instructions
            if (exerciseInstructions) {
                exerciseInstructions.innerHTML = `
                    <h4 style="color: #00f2fe; margin-bottom: 10px;">${exercise.name}</h4>
                    <p style="margin-bottom: 8px;"><strong>Target:</strong> ${exercise.reps} reps √ó ${exercise.sets} sets</p>
                    <p style="margin-bottom: 15px;"><strong>Model:</strong> ${exercise.model.toUpperCase()} Detection</p>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                        <strong>Instructions:</strong> ${exercise.instructions}
                    </div>
                `;
            }
            
            // Reset session data
            resetSessionData();
            addFeedback(`Selected: ${exercise.name} (${exercise.model} model)`, 'info');
        }

        // Reset session data
        function resetSessionData() {
            sessionData = {
                startTime: null,
                reps: 0,
                formScore: 100,
                feedback: [],
                lastRepTime: 0,
                currentState: 'start',
                currentSide: 'right',
                repHistory: []
            };
            
            repCount.textContent = '0';
            formScore.textContent = '100%';
            elapsedSeconds = 0;
            sessionTime.textContent = '0:00';
            
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }

        // Pause/resume session
        function togglePauseSession() {
            if (!isExerciseActive) return;
            
            isExerciseActive = !isExerciseActive;
            if (isExerciseActive) {
                pauseExerciseBtn.innerHTML = '<span>‚è∏</span> Pause';
                addFeedback('Session resumed', 'good');
            } else {
                pauseExerciseBtn.innerHTML = '<span>‚ñ∂</span> Resume';
                addFeedback('Session paused', 'warning');
            }
        }

        // End session
        function endExerciseSession() {
            isTracking = false;
            isExerciseActive = false;
            startExerciseBtn.disabled = false;
            pauseExerciseBtn.disabled = true;
            endSessionBtn.disabled = true;
            
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
            
            if (camera) {
                camera.stop();
            }
            
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            
            addFeedback(`Session ended. Completed ${sessionData.reps} reps in ${minutes}:${seconds.toString().padStart(2, '0')}`, 'good');
            addFeedback(`Final form score: ${sessionData.formScore}%`, 'info');
            
            // Save the session recording
            endSessionRecording();
        }

        // Update timer display
        function updateTimer() {
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            sessionTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Start camera pipeline for active model
        function startCameraPipeline() {
            try {
                if (camera) {
                    camera.stop();
                }
                
                camera = new window.Camera(video, {
                    onFrame: async () => {
                        if (!isTracking) return;
                        
                        try {
                            if (activeModel === 'pose' && pose) {
                                await pose.send({image: video});
                            } else if (activeModel === 'hands' && hands) {
                                await hands.send({image: video});
                            } else if (activeModel === 'face' && faceMesh) {
                                // Ensure faceMesh is initialized
                                if (faceMesh && typeof faceMesh.send === 'function') {
                                    await faceMesh.send({image: video});
                                } else {
                                    console.error('FaceMesh model not properly initialized');
                                }
                            }
                        } catch (error) {
                            console.error('Error in camera pipeline:', error);
                            if (error.message.includes('FaceMesh')) {
                                addFeedback('Face detection error. Please ensure your face is visible.', 'warning');
                            }
                        }
                    },
                    width: 640, // Reduced for better performance
                    height: 480
                });
                
                camera.start();
            } catch (error) {
                console.error('Error starting camera pipeline:', error);
                addFeedback('Error starting camera: ' + error.message, 'error');
            }
        }

        // ===== PATIENT MODAL FUNCTIONS =====

        function showPatientModal() {
            document.getElementById('patientModal').classList.add('active');
        }

        function closePatientModal() {
            document.getElementById('patientModal').classList.remove('active');
        }

        // ===== ADDITIONAL FUNCTIONS =====

        // Function to view progress page
        function viewMyProgress() {
            window.location.href = 'progress.html';
        }

        // Function to show session complete message
        function showSessionCompleteMessage(sessionData) {
            const notification = document.createElement('div');
            notification.className = 'session-notification success';
            notification.innerHTML = `
                <div class="notification-content">
                    <h4>‚úÖ Session Completed Successfully!</h4>
                    <p><strong>Exercise:</strong> ${sessionData.exercise}</p>
                    <p><strong>Reps:</strong> ${sessionData.reps}</p>
                    <p><strong>Form Score:</strong> ${sessionData.accuracy}%</p>
                    <p><strong>Duration:</strong> ${sessionData.duration} minutes</p>
                    <button class="view-progress-btn" onclick="viewMyProgress()">View Full Progress</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Add show class with delay
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Remove after 10 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 10000);
        }

        // Initialize the application
        async function initApp() {
            addFeedback('Initializing application...', 'info');
            
            initBodySelection();
            
            // Initialize webcam
            const cameraStarted = await startWebcam();
            if (!cameraStarted) return;
            
            // Initialize AI models
            const modelsInitialized = await initializeModels();
            if (!modelsInitialized) return;
            
            // Setup video controls
            setupVideoControls();
            
            // Set up event listeners with video guidance
            startExerciseBtn.removeEventListener('click', startExerciseSessionWithVideo);
            startExerciseBtn.addEventListener('click', startExerciseSessionWithVideo);
            
            pauseExerciseBtn.removeEventListener('click', togglePauseSession);
            pauseExerciseBtn.addEventListener('click', togglePauseSession);
            
            endSessionBtn.removeEventListener('click', endExerciseSession);
            endSessionBtn.addEventListener('click', endExerciseSession);
            
            // Setup patient form
            const patientForm = document.getElementById('patientForm');
            if (patientForm) {
                patientForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const patientData = {
                        name: document.getElementById('patientNameInput').value,
                        condition: document.getElementById('patientCondition').value,
                        age: document.getElementById('patientAge').value,
                        notes: document.getElementById('patientNotes').value,
                        date: new Date().toISOString()
                    };
                    
                    localStorage.setItem('currentPatientInfo', JSON.stringify(patientData));
                    closePatientModal();
                    addFeedback(`Patient session started for: ${patientData.name}`, 'good');
                });
            }
            
            // Setup keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const overlay = document.getElementById('videoGuidanceOverlay');
                    if (overlay && overlay.classList.contains('active')) {
                        closeVideoGuidance();
                    }
                    closePatientModal();
                }
            });
            
            // Close video when clicking outside
            const overlay = document.getElementById('videoGuidanceOverlay');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target.id === 'videoGuidanceOverlay') {
                        closeVideoGuidance();
                    }
                });
            }
            
            // Close patient modal when clicking outside
            const patientModalOverlay = document.getElementById('patientModal');
            if (patientModalOverlay) {
                patientModalOverlay.addEventListener('click', (e) => {
                    if (e.target.id === 'patientModal') {
                        closePatientModal();
                    }
                });
            }
            
            addFeedback('Application ready! Select an exercise to begin.', 'good');
        }

        // Start the application
        window.addEventListener('load', initApp);
    </script>

    <!-- Load all MediaPipe models from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</body>
</html>
