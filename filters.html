<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HemaScan Pro - Filters</title>
    <link rel="stylesheet" href="common-styles.css">
</head>
<body>
    <a href="index.html" class="back-btn">â†</a>
    
    <div class="dashboard">
        <div class="header">
            <h1 class="app-title">Image Filters</h1>
            <p class="app-subtitle">ENHANCE DETECTION</p>
        </div>

        <div class="video-container" style="aspect-ratio: 4/3; background: var(--bg-secondary);">
            <img id="originalImage" style="display: none; width: 100%;">
            <canvas id="filterCanvas" style="display: none; width: 100%;"></canvas>
            <video id="liveVideo" autoplay playsinline style="display: none; width: 100%;"></video>
            <div class="video-overlay" id="placeholder">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”§</div>
                <div>Select image or use live camera</div>
            </div>
        </div>

        <input type="file" id="fileInput" accept="image/*" style="display: none;">

        <div class="content-section">
            <div class="section-title">ğŸ¨ Available Filters</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <button class="filter-btn" onclick="applyFilter('grayscale')">Grayscale</button>
                <button class="filter-btn" onclick="applyFilter('contrast')">Contrast</button>
                <button class="filter-btn" onclick="applyFilter('brightness')">Brightness</button>
                <button class="filter-btn" onclick="applyFilter('sharpen')">Sharpen</button>
                <button class="filter-btn" onclick="applyFilter('edge')">Edge Detect</button>
                <button class="filter-btn" onclick="applyFilter('invert')">Invert</button>
                <button class="filter-btn" onclick="applyFilter('blur')">Blur</button>
                <button class="filter-btn" onclick="applyFilter('sepia')">Sepia</button>
                <button class="filter-btn active" onclick="applyFilter('none')">None</button>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">Active Filter: <span id="activeFilter" style="color: var(--accent-blue);">None</span></div>
            <div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px;">
                <input type="range" id="filterStrength" min="0" max="100" value="50" 
                    style="width: 100%; accent-color: var(--accent-blue);"
                    oninput="updateFilterStrength(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    <span>Low</span>
                    <span id="strengthValue">50%</span>
                    <span>High</span>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn primary" onclick="document.getElementById('fileInput').click()">
                ğŸ“ Load
            </button>
            <button class="action-btn success" onclick="toggleLiveMode()" id="liveBtn">
                ğŸ“· Live
            </button>
            <a href="index.html" class="action-btn success">
                ğŸ  Home
            </a>
            <a href="#" class="action-btn danger" onclick="exitApp(event)">
                ğŸšª Exit
            </a>
        </div>
    </div>

    <script>
        let currentImage = null;
        let canvas, ctx;
        let liveVideo, isLiveMode = false;
        let currentFilter = 'none';
        let filterStrength = 50;

        function init() {
            canvas = document.getElementById('filterCanvas');
            ctx = canvas.getContext('2d');
            liveVideo = document.getElementById('liveVideo');

            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            const data = JSON.parse(localStorage.getItem('hemaScanData') || '{"settings":{}}');
            if (data.settings.darkMode) {
                document.documentElement.classList.add('dark-theme');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    document.getElementById('originalImage').src = e.target.result;
                    document.getElementById('originalImage').style.display = 'block';
                    document.getElementById('placeholder').style.display = 'none';
                    canvas.style.display = 'none';
                    liveVideo.style.display = 'none';
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    showNotification('Image loaded', 'success');
                    applyFilter(currentFilter);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function toggleLiveMode() {
            isLiveMode = !isLiveMode;
            
            if (isLiveMode) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    liveVideo.srcObject = stream;
                    liveVideo.style.display = 'block';
                    document.getElementById('originalImage').style.display = 'none';
                    canvas.style.display = 'none';
                    document.getElementById('placeholder').style.display = 'none';
                    document.getElementById('liveBtn').innerHTML = 'â¸ï¸ Stop';
                    showNotification('Live mode activated', 'success');
                } catch (error) {
                    showNotification('Camera access denied', 'error');
                    isLiveMode = false;
                }
            } else {
                if (liveVideo.srcObject) {
                    liveVideo.srcObject.getTracks().forEach(track => track.stop());
                }
                liveVideo.style.display = 'none';
                document.getElementById('liveBtn').innerHTML = 'ğŸ“· Live';
                showNotification('Live mode stopped', 'info');
            }
        }

        function applyFilter(filterType) {
            if (!currentImage && !isLiveMode) {
                showNotification('Please load an image first', 'warning');
                return;
            }

            currentFilter = filterType;
            document.getElementById('activeFilter').textContent = filterType.charAt(0).toUpperCase() + filterType.slice(1);
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (currentImage) {
                ctx.drawImage(currentImage, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                switch(filterType) {
                    case 'grayscale':
                        for (let i = 0; i < data.length; i += 4) {
                            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                            data[i] = data[i + 1] = data[i + 2] = avg;
                        }
                        break;
                    case 'contrast':
                        const factor = (259 * (filterStrength + 255)) / (255 * (259 - filterStrength));
                        for (let i = 0; i < data.length; i += 4) {
                            data[i] = factor * (data[i] - 128) + 128;
                            data[i + 1] = factor * (data[i + 1] - 128) + 128;
                            data[i + 2] = factor * (data[i + 2] - 128) + 128;
                        }
                        break;
                    case 'brightness':
                        const adjust = (filterStrength - 50) * 2;
                        for (let i = 0; i < data.length; i += 4) {
                            data[i] += adjust;
                            data[i + 1] += adjust;
                            data[i + 2] += adjust;
                        }
                        break;
                    case 'invert':
                        for (let i = 0; i < data.length; i += 4) {
                            data[i] = 255 - data[i];
                            data[i + 1] = 255 - data[i + 1];
                            data[i + 2] = 255 - data[i + 2];
                        }
                        break;
                    case 'sepia':
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i], g = data[i + 1], b = data[i + 2];
                            data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                            data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                            data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                        }
                        break;
                }

                if (filterType !== 'none') {
                    ctx.putImageData(imageData, 0, 0);
                    canvas.style.display = 'block';
                    document.getElementById('originalImage').style.display = 'none';
                } else {
                    canvas.style.display = 'none';
                    document.getElementById('originalImage').style.display = 'block';
                }
            }

            showNotification(`${filterType} filter applied`, 'success');
        }

        function updateFilterStrength(value) {
            filterStrength = parseInt(value);
            document.getElementById('strengthValue').textContent = value + '%';
            if (currentFilter !== 'none') {
                applyFilter(currentFilter);
            }
        }

        function exitApp(e) {
            e.preventDefault();
            if (isLiveMode && liveVideo.srcObject) {
                liveVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            window.location.href = 'index.html';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#34c759' : 
                            type === 'error' ? '#ff3b30' : 
                            type === 'warning' ? '#ff9500' : '#007aff'};
                color: white;
                padding: 12px 24px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 500;
                z-index: 9999;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                max-width: 80%;
                text-align: center;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => document.body.removeChild(notification), 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
