<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Microscope Cell Analyzer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a1931 0%, #1a1a2e 100%);
            color: #f5f6fa;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            text-align: center;
            padding: 20px 0 10px;
            margin-bottom: 10px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 5px;
        }
        
        .logo i {
            font-size: 2.2rem;
            color: #4bcffa;
        }
        
        h1 {
            font-size: 1.6rem;
            color: white;
        }
        
        .subtitle {
            color: #d2dae2;
            font-size: 0.9rem;
            margin-top: 3px;
        }
        
        /* Circular camera display */
        .camera-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .camera-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 15px;
        }
        
        .camera-circle {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background-color: #000;
            border: 3px solid #4bcffa;
            box-shadow: 0 0 30px rgba(75, 207, 250, 0.4);
        }
        
        #videoFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .microscope-grid {
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            border-radius: 50%;
        }
        
        .analysis-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            z-index: 20;
        }
        
        .magnification-display {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 30;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .zoom-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .zoom-value {
            font-size: 1.1rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        
        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 15px;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .control-btn.active {
            background: #4bcffa;
            color: #0a1931;
            box-shadow: 0 5px 15px rgba(75, 207, 250, 0.4);
        }
        
        .control-label {
            font-size: 0.7rem;
            margin-top: 5px;
            font-weight: 500;
        }
        
        /* Analysis animation container */
        .analysis-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
            z-index: 25;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .analysis-animation.active {
            opacity: 1;
        }
        
        .flow-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 2px solid rgba(75, 207, 250, 0.3);
            animation: rotate 20s linear infinite;
        }
        
        .flow-animation::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: rgba(75, 207, 250, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(75, 207, 250, 0.8);
        }
        
        @keyframes rotate {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: rgba(75, 207, 250, 0.7);
            border-radius: 50%;
            animation: particle-flow 3s linear infinite;
        }
        
        @keyframes particle-flow {
            0% { 
                transform: rotate(0deg) translateX(140px) rotate(0deg); 
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { 
                transform: rotate(360deg) translateX(140px) rotate(-360deg); 
                opacity: 0;
            }
        }
        
        /* Analysis results */
        .analysis-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .section-title i {
            color: #4bcffa;
        }
        
        .analysis-results {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .result-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .result-item.active {
            background: rgba(75, 207, 250, 0.2);
            transform: scale(1.05);
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4bcffa;
            margin-bottom: 5px;
        }
        
        .result-label {
            font-size: 0.9rem;
            color: #d2dae2;
        }
        
        /* Cell visualization */
        .cell-visualization {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            display: none;
        }
        
        .cell-visualization.active {
            display: block;
        }
        
        .visualization-container {
            position: relative;
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
        }
        
        #cellCanvas {
            width: 100%;
            height: 100%;
        }
        
        .cell-count-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        /* Capture gallery */
        .capture-gallery {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
        }
        
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .gallery-items {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: #4bcffa rgba(255, 255, 255, 0.1);
        }
        
        .gallery-items::-webkit-scrollbar {
            height: 8px;
        }
        
        .gallery-items::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .gallery-items::-webkit-scrollbar-thumb {
            background-color: #4bcffa;
            border-radius: 10px;
        }
        
        .gallery-item {
            min-width: 80px;
            height: 80px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-item.video::after {
            content: "â–¶";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .empty-gallery {
            text-align: center;
            color: #d2dae2;
            padding: 20px 0;
        }
        
        /* Floating menu */
        .floating-menu {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 10px 25px;
            display: flex;
            gap: 25px;
            z-index: 100;
        }
        
        .floating-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }
        
        .floating-menu-btn.active {
            color: #4bcffa;
        }
        
        .floating-menu-btn:hover {
            transform: scale(1.1);
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 200;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Settings panel */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            padding: 20px;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .settings-panel.active {
            display: flex;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .settings-title {
            font-size: 1.5rem;
            color: white;
        }
        
        .close-settings {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .settings-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .settings-option:last-child {
            margin-bottom: 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4bcffa;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .help-text {
            font-size: 0.8rem;
            color: #d2dae2;
            margin-top: 5px;
        }
        
        /* Recording indicator */
        .recording-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #ff3838;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 30;
            display: none;
            align-items: center;
            gap: 5px;
        }
        
        .recording-indicator.active {
            display: flex;
        }
        
        .recording-dot {
            width: 10px;
            height: 10px;
            background-color: white;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 480px) {
            .camera-container {
                width: 280px;
                height: 280px;
            }
            
            .controls {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .control-btn {
                height: 65px;
                font-size: 1.3rem;
            }
            
            .analysis-results {
                grid-template-columns: 1fr;
            }
            
            .floating-menu {
                padding: 10px 20px;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-microscope"></i>
                <h1>Mobile Microscope</h1>
            </div>
            <p class="subtitle">Circular view with real-time cell analysis</p>
        </header>
        
        <div class="camera-section">
            <div class="camera-container">
                <div class="camera-circle">
                    <video id="videoFeed" autoplay playsinline></video>
                    <div class="camera-overlay">
                        <div class="microscope-grid"></div>
                    </div>
                    <canvas class="analysis-canvas" id="analysisCanvas"></canvas>
                    <div class="analysis-animation" id="analysisAnimation">
                        <div class="flow-animation"></div>
                        <div class="particles" id="particlesContainer"></div>
                    </div>
                    <div class="magnification-display">
                        Magnification: <span id="magnificationValue">5x</span>
                    </div>
                    <div class="recording-indicator" id="recordingIndicator">
                        <div class="recording-dot"></div>
                        <span>Recording</span>
                    </div>
                </div>
            </div>
            
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOutBtn">
                    <i class="fas fa-search-minus"></i>
                </button>
                <div class="zoom-value" id="zoomValue">5x</div>
                <button class="zoom-btn" id="zoomInBtn">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>
        </div>
        
        <div class="controls">
            <button class="control-btn" id="captureBtn">
                <i class="fas fa-camera"></i>
                <span class="control-label">Capture</span>
            </button>
            <button class="control-btn" id="recordBtn">
                <i class="fas fa-video"></i>
                <span class="control-label">Record</span>
            </button>
            <button class="control-btn" id="analyzeBtn">
                <i class="fas fa-search"></i>
                <span class="control-label">Analyze</span>
            </button>
            <button class="control-btn" id="settingsBtn">
                <i class="fas fa-cog"></i>
                <span class="control-label">Settings</span>
            </button>
        </div>
        
        <div class="analysis-section">
            <div class="section-title">
                <i class="fas fa-chart-bar"></i>
                <h3>Real-time Cell Analysis</h3>
            </div>
            <div class="analysis-results">
                <div class="result-item" id="rbcResult">
                    <div class="result-value" id="rbcCount">0</div>
                    <div class="result-label">Red Blood Cells</div>
                </div>
                <div class="result-item" id="wbcResult">
                    <div class="result-value" id="wbcCount">0</div>
                    <div class="result-label">White Blood Cells</div>
                </div>
                <div class="result-item" id="plateletResult">
                    <div class="result-value" id="plateletCount">0</div>
                    <div class="result-label">Platelets</div>
                </div>
                <div class="result-item" id="densityResult">
                    <div class="result-value" id="cellDensity">0%</div>
                    <div class="result-label">Cell Density</div>
                </div>
            </div>
        </div>
        
        <div class="cell-visualization" id="cellVisualization">
            <div class="section-title">
                <i class="fas fa-eye"></i>
                <h3>Cell Detection Visualization</h3>
            </div>
            <div class="visualization-container">
                <canvas id="cellCanvas"></canvas>
                <div class="cell-count-display">
                    Cells detected: <span id="totalCellCount">0</span>
                </div>
            </div>
        </div>
        
        <div class="capture-gallery">
            <div class="gallery-header">
                <div class="section-title">
                    <i class="fas fa-images"></i>
                    <h3>Recent Captures</h3>
                </div>
                <button class="zoom-btn" id="clearGalleryBtn" style="width: 40px; height: 40px; font-size: 1rem;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="gallery-items" id="galleryItems">
                <div class="empty-gallery">
                    <p>No captures yet. Use the camera button to capture images.</p>
                </div>
            </div>
        </div>
        
        <div class="floating-menu">
            <button class="floating-menu-btn active" id="homeBtn">
                <i class="fas fa-home"></i>
            </button>
            <button class="floating-menu-btn" id="galleryBtn">
                <i class="fas fa-photo-video"></i>
            </button>
            <button class="floating-menu-btn" id="visualizeBtn">
                <i class="fas fa-eye"></i>
            </button>
            <button class="floating-menu-btn" id="helpBtn">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
        
        <div class="toast" id="toast"></div>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 class="settings-title">Microscope Settings</h2>
            <button class="close-settings" id="closeSettings">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="settings-group">
            <h3>Camera Settings</h3>
            <div class="settings-option">
                <div>
                    <p>Use Rear Camera</p>
                    <p class="help-text">For better quality, use the rear camera</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="rearCameraToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div>
                    <p>Show Detection Overlay</p>
                    <p class="help-text">Display detected cells on camera feed</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="overlayToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div>
                    <p>Analysis Sensitivity</p>
                </div>
                <input type="range" min="1" max="10" value="7" class="zoom-slider" id="sensitivitySlider" style="width: 120px;">
            </div>
        </div>
        
        <div class="settings-group">
            <h3>Visualization</h3>
            <div class="settings-option">
                <div>
                    <p>Show Animation</p>
                    <p class="help-text">Display flow animation during analysis</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="animationToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-option">
                <div>
                    <p>Cell Colors</p>
                </div>
                <select id="cellColorSelect" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px; border-radius: 5px;">
                    <option value="red">Red (RBC)</option>
                    <option value="blue" selected>Blue (WBC)</option>
                    <option value="purple">Purple (Platelets)</option>
                </select>
            </div>
            <div class="settings-option">
                <div>
                    <p>Auto-save Analysis</p>
                    <p class="help-text">Save analysis results with images</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoSaveToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        
        <div class="settings-group">
            <h3>Storage</h3>
            <div class="settings-option">
                <div>
                    <p>Image Quality</p>
                </div>
                <select id="imageQualitySelect" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px; border-radius: 5px;">
                    <option value="high">High</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="settings-option">
                <div>
                    <p>Storage Used</p>
                    <p class="help-text" id="storageUsedText">0 MB of 1 GB used</p>
                </div>
                <button id="clearStorageBtn" style="background: #ff3838; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Clear All</button>
            </div>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const videoFeed = document.getElementById('videoFeed');
        const captureBtn = document.getElementById('captureBtn');
        const recordBtn = document.getElementById('recordBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const analysisCanvas = document.getElementById('analysisCanvas');
        const cellCanvas = document.getElementById('cellCanvas');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const analysisAnimation = document.getElementById('analysisAnimation');
        const particlesContainer = document.getElementById('particlesContainer');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomValue = document.getElementById('zoomValue');
        const magnificationValue = document.getElementById('magnificationValue');
        const galleryItems = document.getElementById('galleryItems');
        const clearGalleryBtn = document.getElementById('clearGalleryBtn');
        const toast = document.getElementById('toast');
        const settingsPanel = document.getElementById('settingsPanel');
        const closeSettings = document.getElementById('closeSettings');
        const clearStorageBtn = document.getElementById('clearStorageBtn');
        const cellVisualization = document.getElementById('cellVisualization');
        const storageUsedText = document.getElementById('storageUsedText');
        
        // Analysis result elements
        const rbcCount = document.getElementById('rbcCount');
        const wbcCount = document.getElementById('wbcCount');
        const plateletCount = document.getElementById('plateletCount');
        const cellDensity = document.getElementById('cellDensity');
        const totalCellCount = document.getElementById('totalCellCount');
        
        // Result containers for animation
        const rbcResult = document.getElementById('rbcResult');
        const wbcResult = document.getElementById('wbcResult');
        const plateletResult = document.getElementById('plateletResult');
        const densityResult = document.getElementById('densityResult');
        
        // State variables
        let isRecording = false;
        let isAnalyzing = false;
        let mediaRecorder;
        let recordedChunks = [];
        let stream = null;
        let analysisInterval = null;
        let cellDetectionInterval = null;
        let captures = JSON.parse(localStorage.getItem('microscopeCaptures')) || [];
        let zoomLevel = 5;
        let cellDetectionData = {
            rbc: 0,
            wbc: 0,
            platelets: 0,
            density: 0,
            total: 0
        };
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initCamera();
            setupEventListeners();
            updateGallery();
            createParticles();
            updateStorageUsed();
            
            // Initialize canvas contexts
            analysisCanvas.width = 300;
            analysisCanvas.height = 300;
            cellCanvas.width = cellCanvas.parentElement.clientWidth;
            cellCanvas.height = cellCanvas.parentElement.clientHeight;
            
            // Start with cell visualization hidden
            cellVisualization.classList.remove('active');
        });
        
        // Initialize camera
        async function initCamera() {
            try {
                // Request camera access
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                videoFeed.srcObject = stream;
                showToast('Camera activated successfully');
            } catch (error) {
                console.error('Error accessing camera:', error);
                showToast('Unable to access camera. Please check permissions.');
                
                // Show placeholder for demo purposes
                videoFeed.style.backgroundColor = '#333';
                videoFeed.style.display = 'flex';
                videoFeed.style.alignItems = 'center';
                videoFeed.style.justifyContent = 'center';
                videoFeed.innerHTML = '<div style="text-align: center;"><i class="fas fa-microscope" style="font-size: 3rem; margin-bottom: 10px;"></i><p>Camera feed would appear here</p></div>';
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Capture button
            captureBtn.addEventListener('click', captureImage);
            
            // Record button
            recordBtn.addEventListener('click', toggleRecording);
            
            // Analyze button
            analyzeBtn.addEventListener('click', toggleAnalysis);
            
            // Settings button
            settingsBtn.addEventListener('click', () => {
                settingsPanel.classList.add('active');
            });
            
            // Close settings
            closeSettings.addEventListener('click', () => {
                settingsPanel.classList.remove('active');
            });
            
            // Zoom buttons
            zoomInBtn.addEventListener('click', () => {
                if (zoomLevel < 10) {
                    zoomLevel++;
                    updateZoomDisplay();
                    showToast(`Magnification increased to ${zoomLevel}x`);
                }
            });
            
            zoomOutBtn.addEventListener('click', () => {
                if (zoomLevel > 1) {
                    zoomLevel--;
                    updateZoomDisplay();
                    showToast(`Magnification decreased to ${zoomLevel}x`);
                }
            });
            
            // Clear gallery
            clearGalleryBtn.addEventListener('click', clearGallery);
            
            // Clear storage
            clearStorageBtn.addEventListener('click', clearStorage);
            
            // Floating menu buttons
            document.getElementById('homeBtn').addEventListener('click', () => {
                setActiveMenuButton('homeBtn');
                showToast('Home view activated');
            });
            
            document.getElementById('galleryBtn').addEventListener('click', () => {
                setActiveMenuButton('galleryBtn');
                // Scroll to gallery
                document.querySelector('.capture-gallery').scrollIntoView({ behavior: 'smooth' });
                showToast('Viewing gallery');
            });
            
            document.getElementById('visualizeBtn').addEventListener('click', () => {
                setActiveMenuButton('visualizeBtn');
                toggleCellVisualization();
                showToast('Cell visualization toggled');
            });
            
            document.getElementById('helpBtn').addEventListener('click', () => {
                setActiveMenuButton('helpBtn');
                showToast('Help & tutorial view activated');
            });
            
            // Settings toggles
            document.getElementById('overlayToggle').addEventListener('change', function() {
                showToast(this.checked ? 'Detection overlay enabled' : 'Detection overlay disabled');
            });
            
            document.getElementById('animationToggle').addEventListener('change', function() {
                showToast(this.checked ? 'Analysis animation enabled' : 'Analysis animation disabled');
            });
            
            // Window resize handler
            window.addEventListener('resize', () => {
                cellCanvas.width = cellCanvas.parentElement.clientWidth;
                cellCanvas.height = cellCanvas.parentElement.clientHeight;
            });
        }
        
        // Update zoom display
        function updateZoomDisplay() {
            zoomValue.textContent = `${zoomLevel}x`;
            magnificationValue.textContent = `${zoomLevel}x`;
        }
        
        // Capture image
        function captureImage() {
            // Create a canvas to capture the image
            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 300;
            
            const context = canvas.getContext('2d');
            
            // Draw a circular image from the video feed
            context.beginPath();
            context.arc(150, 150, 150, 0, Math.PI * 2, true);
            context.closePath();
            context.clip();
            
            // Draw the video frame
            context.drawImage(videoFeed, 0, 0, 300, 300);
            
            // Add overlay for analysis if active
            if (isAnalyzing) {
                context.globalAlpha = 0.3;
                context.fillStyle = '#4bcffa';
                context.fillRect(0, 0, 300, 300);
                context.globalAlpha = 1.0;
                
                // Add analysis text
                context.font = 'bold 16px Arial';
                context.fillStyle = 'white';
                context.strokeStyle = 'black';
                context.lineWidth = 3;
                context.textAlign = 'center';
                
                const analysisText = `Analysis: ${cellDetectionData.total} cells`;
                context.strokeText(analysisText, 150, 280);
                context.fillText(analysisText, 150, 280);
            }
            
            // Add timestamp and magnification info
            context.font = '14px Arial';
            context.fillStyle = 'white';
            context.strokeStyle = 'black';
            context.lineWidth = 2;
            context.textAlign = 'center';
            
            const timestamp = new Date().toLocaleTimeString();
            context.strokeText(`Mag: ${zoomLevel}x | ${timestamp}`, 150, 30);
            context.fillText(`Mag: ${zoomLevel}x | ${timestamp}`, 150, 30);
            
            // Convert to data URL
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            
            // Save the capture
            const capture = {
                id: Date.now(),
                type: 'image',
                data: imageData,
                timestamp: new Date().toISOString(),
                magnification: zoomLevel,
                analysis: isAnalyzing ? {...cellDetectionData} : null
            };
            
            captures.unshift(capture);
            if (captures.length > 12) captures.length = 12;
            
            // Save to localStorage
            localStorage.setItem('microscopeCaptures', JSON.stringify(captures));
            
            // Update gallery and storage display
            updateGallery();
            updateStorageUsed();
            
            // Show success message
            showToast('Image captured successfully');
            
            // Animate capture button
            captureBtn.classList.add('active');
            setTimeout(() => captureBtn.classList.remove('active'), 300);
        }
        
        // Toggle video recording
        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        // Start recording
        function startRecording() {
            if (!stream) {
                showToast('Camera not available');
                return;
            }
            
            recordedChunks = [];
            
            try {
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm; codecs=vp9'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    // Create video blob
                    const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                    const videoUrl = URL.createObjectURL(videoBlob);
                    
                    // Save the recording
                    const capture = {
                        id: Date.now(),
                        type: 'video',
                        data: videoUrl,
                        timestamp: new Date().toISOString(),
                        magnification: zoomLevel,
                        duration: Math.floor((Date.now() - recordingStartTime) / 1000)
                    };
                    
                    captures.unshift(capture);
                    if (captures.length > 12) captures.length = 12;
                    
                    localStorage.setItem('microscopeCaptures', JSON.stringify(captures));
                    updateGallery();
                    updateStorageUsed();
                    
                    showToast(`Video recorded (${capture.duration}s)`);
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordBtn.classList.add('active');
                recordingIndicator.classList.add('active');
                showToast('Recording started');
                
                // Store start time for duration calculation
                recordingStartTime = Date.now();
            } catch (error) {
                console.error('Error starting recording:', error);
                showToast('Unable to start recording');
            }
        }
        
        // Stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.classList.remove('active');
                recordingIndicator.classList.remove('active');
            }
        }
        
        // Toggle analysis
        function toggleAnalysis() {
            if (isAnalyzing) {
                stopAnalysis();
                analyzeBtn.classList.remove('active');
                showToast('Analysis stopped');
            } else {
                startAnalysis();
                analyzeBtn.classList.add('active');
                showToast('Analysis started');
            }
        }
        
        // Start analysis
        function startAnalysis() {
            isAnalyzing = true;
            analysisAnimation.classList.add('active');
            
            // Start cell detection visualization
            startCellDetection();
            
            // Update analysis results continuously
            analysisInterval = setInterval(updateAnalysisResults, 1500);
            
            // Highlight analysis section
            rbcResult.classList.add('active');
            setTimeout(() => wbcResult.classList.add('active'), 300);
            setTimeout(() => plateletResult.classList.add('active'), 600);
            setTimeout(() => densityResult.classList.add('active'), 900);
        }
        
        // Stop analysis
        function stopAnalysis() {
            isAnalyzing = false;
            analysisAnimation.classList.remove('active');
            
            // Stop cell detection
            stopCellDetection();
            
            // Clear intervals
            if (analysisInterval) {
                clearInterval(analysisInterval);
                analysisInterval = null;
            }
            
            // Remove highlights
            rbcResult.classList.remove('active');
            wbcResult.classList.remove('active');
            plateletResult.classList.remove('active');
            densityResult.classList.remove('active');
            
            // Clear analysis canvas
            const ctx = analysisCanvas.getContext('2d');
            ctx.clearRect(0, 0, analysisCanvas.width, analysisCanvas.height);
        }
        
        // Start cell detection visualization
        function startCellDetection() {
            // Clear previous interval
            if (cellDetectionInterval) clearInterval(cellDetectionInterval);
            
            // Initial update
            updateCellDetection();
            
            // Set up interval for continuous updates
            cellDetectionInterval = setInterval(updateCellDetection, 100);
        }
        
        // Stop cell detection
        function stopCellDetection() {
            if (cellDetectionInterval) {
                clearInterval(cellDetectionInterval);
                cellDetectionInterval = null;
            }
        }
        
        // Update cell detection visualization
        function updateCellDetection() {
            // Update analysis results
            updateAnalysisResults();
            
            // Draw on analysis canvas (overlay on camera feed)
            const ctx = analysisCanvas.getContext('2d');
            ctx.clearRect(0, 0, analysisCanvas.width, analysisCanvas.height);
            
            // Draw detected cells as circles
            const cellCount = 15 + Math.floor(Math.random() * 30); // Simulate varying cell count
            
            // Generate random cells
            const cells = [];
            for (let i = 0; i < cellCount; i++) {
                cells.push({
                    x: Math.random() * 300,
                    y: Math.random() * 300,
                    radius: 3 + Math.random() * 6,
                    type: Math.floor(Math.random() * 3), // 0=RBC, 1=WBC, 2=Platelet
                    pulse: Math.random() * Math.PI * 2
                });
            }
            
            // Draw cells
            cells.forEach(cell => {
                // Check if cell is within circular area
                const dx = cell.x - 150;
                const dy = cell.y - 150;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < 150 - cell.radius) {
                    // Set color based on cell type
                    if (cell.type === 0) {
                        ctx.fillStyle = 'rgba(255, 50, 50, 0.8)'; // Red for RBC
                    } else if (cell.type === 1) {
                        ctx.fillStyle = 'rgba(50, 150, 255, 0.8)'; // Blue for WBC
                    } else {
                        ctx.fillStyle = 'rgba(150, 50, 255, 0.8)'; // Purple for platelets
                    }
                    
                    // Add pulsing effect
                    const pulseSize = Math.sin(cell.pulse) * 0.5 + 1;
                    cell.pulse += 0.1;
                    
                    // Draw cell
                    ctx.beginPath();
                    ctx.arc(cell.x, cell.y, cell.radius * pulseSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw highlight
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.beginPath();
                    ctx.arc(cell.x - cell.radius/3, cell.y - cell.radius/3, cell.radius/2, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Update cell visualization if active
            if (cellVisualization.classList.contains('active')) {
                updateCellVisualization(cells);
            }
        }
        
        // Update analysis results
        function updateAnalysisResults() {
            // Generate realistic but varying cell counts
            const baseRBC = 120;
            const baseWBC = 8;
            const basePlatelets = 300;
            
            // Add some randomness to simulate different samples
            const rbcVariation = Math.floor(Math.random() * 40) - 20;
            const wbcVariation = Math.floor(Math.random() * 6) - 3;
            const plateletVariation = Math.floor(Math.random() * 80) - 40;
            const densityVariation = Math.floor(Math.random() * 20) - 10;
            
            // Update cell detection data
            cellDetectionData.rbc = Math.max(0, baseRBC + rbcVariation);
            cellDetectionData.wbc = Math.max(0, baseWBC + wbcVariation);
            cellDetectionData.platelets = Math.max(0, basePlatelets + plateletVariation);
            cellDetectionData.density = Math.max(0, Math.min(100, 75 + densityVariation));
            cellDetectionData.total = cellDetectionData.rbc + cellDetectionData.wbc + cellDetectionData.platelets;
            
            // Update the display with new values
            rbcCount.textContent = cellDetectionData.rbc;
            wbcCount.textContent = cellDetectionData.wbc;
            plateletCount.textContent = cellDetectionData.platelets;
            cellDensity.textContent = cellDetectionData.density + '%';
            totalCellCount.textContent = cellDetectionData.total;
        }
        
        // Update cell visualization canvas
        function updateCellVisualization(cells) {
            const ctx = cellCanvas.getContext('2d');
            const width = cellCanvas.width;
            const height = cellCanvas.height;
            
            // Clear canvas with a dark background
            ctx.fillStyle = 'rgba(10, 10, 20, 0.8)';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            
            // Vertical lines
            for (let x = 0; x < width; x += 30) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let y = 0; y < height; y += 30) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Scale cells to fit visualization
            const scaleX = width / 300;
            const scaleY = height / 300;
            
            // Draw cells
            cells.forEach(cell => {
                const x = cell.x * scaleX;
                const y = cell.y * scaleY;
                const radius = cell.radius * Math.min(scaleX, scaleY);
                
                // Set color based on cell type
                if (cell.type === 0) {
                    ctx.fillStyle = 'rgba(255, 50, 50, 0.9)'; // Red for RBC
                } else if (cell.type === 1) {
                    ctx.fillStyle = 'rgba(50, 150, 255, 0.9)'; // Blue for WBC
                } else {
                    ctx.fillStyle = 'rgba(150, 50, 255, 0.9)'; // Purple for platelets
                }
                
                // Draw cell
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw cell border
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Draw nucleus for WBC
                if (cell.type === 1) {
                    ctx.fillStyle = 'rgba(200, 220, 255, 0.9)';
                    ctx.beginPath();
                    ctx.arc(x, y, radius * 0.6, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Draw analysis info
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`RBC: ${cellDetectionData.rbc}`, 10, 20);
            ctx.fillText(`WBC: ${cellDetectionData.wbc}`, 10, 40);
            ctx.fillText(`Platelets: ${cellDetectionData.platelets}`, 10, 60);
            ctx.fillText(`Density: ${cellDetectionData.density}%`, 10, 80);
        }
        
        // Toggle cell visualization
        function toggleCellVisualization() {
            if (cellVisualization.classList.contains('active')) {
                cellVisualization.classList.remove('active');
            } else {
                cellVisualization.classList.add('active');
                // Update visualization if analysis is active
                if (isAnalyzing) {
                    updateCellDetection();
                }
            }
        }
        
        // Create particles for analysis animation
        function createParticles() {
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Randomize animation delay
                particle.style.animationDelay = `${Math.random() * 3}s`;
                
                particlesContainer.appendChild(particle);
            }
        }
        
        // Update gallery display
        function updateGallery() {
            if (captures.length === 0) {
                galleryItems.innerHTML = '<div class="empty-gallery"><p>No captures yet. Use the camera button to capture images.</p></div>';
                return;
            }
            
            galleryItems.innerHTML = '';
            
            captures.forEach(capture => {
                const item = document.createElement('div');
                item.className = `gallery-item ${capture.type}`;
                item.dataset.id = capture.id;
                
                if (capture.type === 'image') {
                    const img = document.createElement('img');
                    img.src = capture.data;
                    img.alt = 'Microscope capture';
                    item.appendChild(img);
                    
                    // Add analysis indicator if available
                    if (capture.analysis) {
                        const indicator = document.createElement('div');
                        indicator.style.position = 'absolute';
                        indicator.style.top = '5px';
                        indicator.style.left = '5px';
                        indicator.style.background = 'rgba(75, 207, 250, 0.8)';
                        indicator.style.color = 'white';
                        indicator.style.width = '18px';
                        indicator.style.height = '18px';
                        indicator.style.borderRadius = '50%';
                        indicator.style.display = 'flex';
                        indicator.style.alignItems = 'center';
                        indicator.style.justifyContent = 'center';
                        indicator.style.fontSize = '0.6rem';
                        indicator.innerHTML = '<i class="fas fa-search"></i>';
                        item.appendChild(indicator);
                    }
                } else {
                    // For videos
                    item.style.backgroundColor = '#222';
                    item.style.display = 'flex';
                    item.style.alignItems = 'center';
                    item.style.justifyContent = 'center';
                    item.innerHTML = `<i class="fas fa-video" style="font-size: 1.5rem; color: #4bcffa;"></i>`;
                    
                    // Add duration badge
                    const duration = document.createElement('div');
                    duration.style.position = 'absolute';
                    duration.style.bottom = '5px';
                    duration.style.right = '5px';
                    duration.style.background = 'rgba(0, 0, 0, 0.7)';
                    duration.style.color = 'white';
                    duration.style.padding = '2px 5px';
                    duration.style.borderRadius = '3px';
                    duration.style.fontSize = '0.6rem';
                    duration.textContent = `${capture.duration}s`;
                    item.appendChild(duration);
                }
                
                // Add click event to view details
                item.addEventListener('click', function(e) {
                    if (capture.type === 'image') {
                        // In a real app, this would open the image in full screen
                        const time = new Date(capture.timestamp).toLocaleTimeString();
                        showToast(`Viewing image captured at ${time} (${capture.magnification}x)`);
                    } else {
                        showToast(`Playing ${capture.duration}s video`);
                    }
                });
                
                galleryItems.appendChild(item);
            });
        }
        
        // Clear gallery
        function clearGallery() {
            if (captures.length === 0) {
                showToast('Gallery is already empty');
                return;
            }
            
            if (confirm('Are you sure you want to clear all captured images and videos?')) {
                captures = [];
                localStorage.removeItem('microscopeCaptures');
                updateGallery();
                updateStorageUsed();
                showToast('Gallery cleared');
            }
        }
        
        // Clear storage
        function clearStorage() {
            if (confirm('Are you sure you want to clear all app data (captures and settings)?')) {
                localStorage.clear();
                captures = [];
                updateGallery();
                updateStorageUsed();
                showToast('All data cleared');
                settingsPanel.classList.remove('active');
            }
        }
        
        // Update storage used display
        function updateStorageUsed() {
            // Calculate approximate storage used
            const imageSize = 50; // KB per image (approximate)
            const videoSize = 500; // KB per video (approximate)
            
            let totalSize = 0;
            captures.forEach(capture => {
                totalSize += capture.type === 'image' ? imageSize : videoSize;
            });
            
            const totalMB = (totalSize / 1024).toFixed(1);
            storageUsedText.textContent = `${totalMB} MB of 1 GB used`;
        }
        
        // Show toast notification
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Set active menu button
        function setActiveMenuButton(activeId) {
            // Remove active class from all buttons
            document.querySelectorAll('.floating-menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            document.getElementById(activeId).classList.add('active');
        }
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Stop recording and analysis when page is hidden
                if (isRecording) stopRecording();
                if (isAnalyzing) stopAnalysis();
            }
        });
    </script>
</body>
</html>