<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HemaScan Pro - Analysis Reports</title>
    <link rel="stylesheet" href="common-styles.css">
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1 class="app-title">üìä Analysis Reports</h1>
            <p class="app-subtitle">HISTORICAL DATA & STATISTICS</p>
        </div>

        <div class="results-grid">
            <div class="result-card">
                <div class="result-label">Total Readings</div>
                <div class="result-value" id="totalReadings">0</div>
            </div>
            <div class="result-card">
                <div class="result-label">Avg. RBC</div>
                <div class="result-value" id="avgRBC">0</div>
            </div>
            <div class="result-card">
                <div class="result-label">Avg. WBC</div>
                <div class="result-value" id="avgWBC">0</div>
            </div>
            <div class="result-card">
                <div class="result-label">Success Rate</div>
                <div class="result-value" id="successRate">0%</div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">üìã Last 5 Readings</div>
            <div id="readingsList" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 30px; color: #b0b9c8;">
                    No readings yet. Start analyzing!
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">üìà Trend Analysis</div>
            <div style="padding: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="font-size: 14px; color: #666;">RBC Trend</span>
                    <span style="font-size: 14px; font-weight: 600; color: #34c759;" id="rbcTrend">-</span>
                </div>
                <div class="progress-bar" style="margin: 10px 0;">
                    <div class="progress-fill" id="rbcTrendBar" style="width: 50%; background: #34c759;"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; margin-top: 20px;">
                    <span style="font-size: 14px; color: #666;">WBC Trend</span>
                    <span style="font-size: 14px; font-weight: 600; color: #ff3b30;" id="wbcTrend">-</span>
                </div>
                <div class="progress-bar" style="margin: 10px 0;">
                    <div class="progress-fill" id="wbcTrendBar" style="width: 50%; background: #ff3b30;"></div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn primary" onclick="refreshData()">
                üîÑ Refresh
            </button>
            <button class="action-btn danger" onclick="clearAllData()">
                üóëÔ∏è Clear Data
            </button>
        </div>

        <div class="action-buttons">
            <button class="action-btn success" onclick="window.location.href='index.html'">
                üè† Home
            </button>
            <button class="action-btn danger" onclick="window.location.href='index.html'">
                ‚ùå Close
            </button>
        </div>
    </div>

    <script>
        function loadAnalysisData() {
            const savedData = localStorage.getItem('hemaScanData');
            
            if (!savedData) {
                return;
            }

            const data = JSON.parse(savedData);
            const readings = data.readings || [];

            if (readings.length === 0) {
                return;
            }

            // Calculate statistics
            const totalReadings = readings.length;
            const avgRBC = Math.round(readings.reduce((sum, r) => sum + (r.rbcCount || 0), 0) / totalReadings);
            const avgWBC = Math.round(readings.reduce((sum, r) => sum + (r.wbcCount || 0), 0) / totalReadings);
            const successRate = Math.round((readings.filter(r => r.totalCells > 0).length / totalReadings) * 100);

            // Update statistics display
            document.getElementById('totalReadings').textContent = totalReadings;
            document.getElementById('avgRBC').textContent = avgRBC;
            document.getElementById('avgWBC').textContent = avgWBC;
            document.getElementById('successRate').textContent = successRate + '%';

            // Calculate trends
            if (readings.length >= 2) {
                const recentReadings = readings.slice(-5);
                const oldReadings = readings.slice(0, Math.min(5, readings.length - 5));
                
                const recentAvgRBC = recentReadings.reduce((sum, r) => sum + (r.rbcCount || 0), 0) / recentReadings.length;
                const oldAvgRBC = oldReadings.length > 0 ? oldReadings.reduce((sum, r) => sum + (r.rbcCount || 0), 0) / oldReadings.length : recentAvgRBC;
                
                const recentAvgWBC = recentReadings.reduce((sum, r) => sum + (r.wbcCount || 0), 0) / recentReadings.length;
                const oldAvgWBC = oldReadings.length > 0 ? oldReadings.reduce((sum, r) => sum + (r.wbcCount || 0), 0) / oldReadings.length : recentAvgWBC;

                const rbcChange = ((recentAvgRBC - oldAvgRBC) / oldAvgRBC * 100).toFixed(1);
                const wbcChange = ((recentAvgWBC - oldAvgWBC) / oldAvgWBC * 100).toFixed(1);

                document.getElementById('rbcTrend').textContent = (rbcChange > 0 ? '+' : '') + rbcChange + '%';
                document.getElementById('wbcTrend').textContent = (wbcChange > 0 ? '+' : '') + wbcChange + '%';

                document.getElementById('rbcTrendBar').style.width = Math.min(100, Math.abs(rbcChange) * 2) + '%';
                document.getElementById('wbcTrendBar').style.width = Math.min(100, Math.abs(wbcChange) * 2) + '%';
            }

            // Display last 5 readings
            const list = document.getElementById('readingsList');
            list.innerHTML = '';

            const last5 = readings.slice(-5).reverse();
            
            last5.forEach((reading, index) => {
                const date = new Date(reading.timestamp);
                const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const dateStr = date.toLocaleDateString();
                
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 15px;
                    border-bottom: 1px solid #f0f2f5;
                    background: ${index % 2 === 0 ? '#fafbfc' : 'white'};
                    border-radius: 10px;
                    margin-bottom: 8px;
                `;
                
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; color: #333; font-size: 16px;">
                                ${reading.source === 'image' ? 'üñºÔ∏è' : 'üì∑'} Reading #${readings.length - index}
                            </div>
                            <div style="font-size: 12px; color: #7a8ba9; margin-top: 4px;">
                                ${dateStr} at ${timeStr}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 20px; color: #3f7bfd; font-weight: 700;">
                                ${reading.totalCells || 0}
                            </div>
                            <div style="font-size: 11px; color: #7a8ba9;">
                                Total Cells
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1; background: #e8f5e9; padding: 8px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #2e7d32;">RBC</div>
                            <div style="font-size: 16px; font-weight: 600; color: #2e7d32;">
                                ${reading.rbcCount || 0}
                            </div>
                        </div>
                        <div style="flex: 1; background: #ffebee; padding: 8px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #c62828;">WBC</div>
                            <div style="font-size: 16px; font-weight: 600; color: #c62828;">
                                ${reading.wbcCount || 0}
                            </div>
                        </div>
                        <div style="flex: 1; background: #e3f2fd; padding: 8px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #1565c0;">Time</div>
                            <div style="font-size: 14px; font-weight: 600; color: #1565c0;">
                                ${reading.processingTime || 0}ms
                            </div>
                        </div>
                    </div>
                    
                    ${reading.confidence ? `
                        <div style="margin-top: 8px; padding: 6px; background: #fff3e0; border-radius: 6px;">
                            <span style="font-size: 11px; color: #e65100;">Confidence: </span>
                            <span style="font-size: 12px; font-weight: 600; color: #e65100;">
                                ${reading.confidence}%
                            </span>
                        </div>
                    ` : ''}
                `;
                
                list.appendChild(item);
            });
        }

        function refreshData() {
            loadAnalysisData();
            alert('Data refreshed successfully!');
        }

        function clearAllData() {
            const savedData = localStorage.getItem('hemaScanData');
            
            if (!savedData) {
                alert('No data to clear!');
                return;
            }

            const data = JSON.parse(savedData);
            
            if (!data.readings || data.readings.length === 0) {
                alert('No data to clear!');
                return;
            }

            if (confirm('Are you sure you want to clear all analysis data? This cannot be undone.')) {
                localStorage.removeItem('hemaScanData');
                
                // Reset display
                document.getElementById('totalReadings').textContent = '0';
                document.getElementById('avgRBC').textContent = '0';
                document.getElementById('avgWBC').textContent = '0';
                document.getElementById('successRate').textContent = '0%';
                document.getElementById('rbcTrend').textContent = '-';
                document.getElementById('wbcTrend').textContent = '-';
                document.getElementById('rbcTrendBar').style.width = '0%';
                document.getElementById('wbcTrendBar').style.width = '0%';
                
                document.getElementById('readingsList').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #b0b9c8;">
                        No readings yet. Start analyzing!
                    </div>
                `;
                
                alert('All data has been cleared!');
            }
        }

        function checkClinicalMode() {
            const clinicalMode = localStorage.getItem('clinicalMode') === 'true';
            if (clinicalMode) {
                document.body.classList.add('dark-mode');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisData();
            checkClinicalMode();
        });
    </script>
</body>
</html>
