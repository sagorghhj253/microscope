<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HemaScan Pro - Analysis</title>
    <link rel="stylesheet" href="common-styles.css">
</head>
<body>
    <a href="index.html" class="back-btn">‚Üê</a>
    
    <div class="dashboard">
        <div class="header">
            <h1 class="app-title">Analysis Report</h1>
            <p class="app-subtitle">HISTORICAL DATA</p>
        </div>

        <div class="results-grid">
            <div class="result-card">
                <div class="result-label">Total Readings</div>
                <div class="result-value" id="totalReadings">0</div>
            </div>
            <div class="result-card">
                <div class="result-label">Avg. RBC</div>
                <div class="result-value" id="avgRBC">0</div>
            </div>
            <div class="result-card">
                <div class="result-label">Avg. WBC</div>
                <div class="result-value" id="avgWBC">0</div>
            </div>
            <div class="result-card">
                <div class="result-label">Success Rate</div>
                <div class="result-value" id="successRate">0%</div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-title">üìã Last 5 Readings</div>
            <div id="readingsList" style="max-height: 400px; overflow-y: auto;">
                <!-- Readings will be inserted here -->
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn primary" onclick="refreshData()">
                üîÑ Refresh
            </button>
            <button class="action-btn danger" onclick="clearAllData()">
                üóëÔ∏è Clear
            </button>
            <a href="index.html" class="action-btn success">
                üè† Home
            </a>
            <a href="#" class="action-btn danger" onclick="exitApp(event)">
                üö™ Exit
            </a>
        </div>
    </div>

    <script>
        function init() {
            loadAnalysisData();
            
            const data = JSON.parse(localStorage.getItem('hemaScanData') || '{"settings":{}}');
            if (data.settings.darkMode) {
                document.documentElement.classList.add('dark-theme');
            }
        }

        function loadAnalysisData() {
            const data = JSON.parse(localStorage.getItem('hemaScanData') || '{"readings":[],"settings":{}}');
            const readings = data.readings;

            if (readings.length === 0) {
                document.getElementById('readingsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
                        <div>No readings yet</div>
                        <div style="font-size: 12px; margin-top: 8px;">Start analyzing to see data</div>
                    </div>
                `;
                return;
            }

            // Calculate statistics
            const totalReadings = readings.length;
            const avgRBC = Math.round(readings.reduce((sum, r) => sum + (r.rbcCount || 0), 0) / totalReadings);
            const avgWBC = Math.round(readings.reduce((sum, r) => sum + (r.wbcCount || 0), 0) / totalReadings);
            const successRate = Math.round((readings.filter(r => r.totalCells > 0).length / totalReadings) * 100);

            // Update statistics
            document.getElementById('totalReadings').textContent = totalReadings;
            document.getElementById('avgRBC').textContent = avgRBC;
            document.getElementById('avgWBC').textContent = avgWBC;
            document.getElementById('successRate').textContent = successRate + '%';

            // Display last 5 readings
            const list = document.getElementById('readingsList');
            list.innerHTML = '';
            
            const lastFive = readings.slice(-5).reverse();
            lastFive.forEach((reading, index) => {
                const time = new Date(reading.timestamp).toLocaleString();
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 15px;
                    border-bottom: 1px solid var(--border-color);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background: ${index % 2 === 0 ? 'var(--bg-secondary)' : 'var(--bg-card)'};
                    border-radius: 10px;
                    margin-bottom: 8px;
                `;
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                            ${reading.totalCells} cells detected
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${reading.source === 'image' ? 'üñºÔ∏è Image' : 'üì∑ Live'} ‚Ä¢ ${time}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: var(--accent-red); font-weight: 600;">
                            RBC: ${reading.rbcCount}
                        </div>
                        <div style="font-size: 12px; color: var(--accent-blue);">
                            WBC: ${reading.wbcCount}
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function refreshData() {
            loadAnalysisData();
            showNotification('Data refreshed', 'success');
        }

        function clearAllData() {
            if (confirm('Clear all analysis data? This cannot be undone.')) {
                localStorage.setItem('hemaScanData', JSON.stringify({"readings":[],"settings":{}}));
                loadAnalysisData();
                showNotification('All data cleared', 'success');
            }
        }

        function exitApp(e) {
            e.preventDefault();
            window.location.href = 'index.html';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#34c759' : 
                            type === 'error' ? '#ff3b30' : 
                            type === 'warning' ? '#ff9500' : '#007aff'};
                color: white;
                padding: 12px 24px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 500;
                z-index: 9999;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                max-width: 80%;
                text-align: center;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => document.body.removeChild(notification), 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
